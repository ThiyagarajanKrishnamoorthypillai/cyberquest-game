<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberQuest: Operation Digital Shield</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg-primary: #000000;
            --color-bg-secondary: #0a0e27;
            --color-bg-tertiary: #141930;
            --color-accent-cyan: #00d4ff;
            --color-accent-green: #00ff88;
            --color-danger: #ff4444;
            --color-warning: #ffaa00;
            --color-text-primary: #ffffff;
            --color-text-secondary: #8b95a5;
            --color-glass: rgba(20, 25, 48, 0.7);
            
            --font-display: 'Orbitron', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Grid Background */
        .grid-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1),
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 999;
            opacity: 0.4;
        }

        /* Container */
        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            max-width: 600px;
            width: 100%;
        }

        .game-title {
            text-align: center;
            margin-bottom: 40px;
        }

        .game-title h1 {
            font-family: var(--font-display);
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--color-accent-cyan), var(--color-accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
            animation: glitchTitle 3s infinite;
        }

        @keyframes glitchTitle {
            0%, 90%, 100% { transform: translate(0); }
            91% { transform: translate(-2px, 2px); }
            93% { transform: translate(2px, -2px); }
            95% { transform: translate(-1px, 1px); }
        }

        .game-subtitle {
            font-family: var(--font-display);
            font-size: 16px;
            color: var(--color-accent-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .mission-brief {
            padding: 30px;
            margin-bottom: 30px;
            border-left: 4px solid var(--color-danger);
        }

        .mission-brief h2 {
            font-family: var(--font-display);
            color: var(--color-danger);
            margin-bottom: 15px;
            font-size: 20px;
            text-transform: uppercase;
        }

        .mission-brief p {
            color: var(--color-text-secondary);
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .role-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-card {
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .role-card:hover {
            border-color: var(--color-accent-cyan);
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
        }

        .role-card.active {
            border-color: var(--color-accent-green);
            background: rgba(0, 255, 136, 0.1);
        }

        .role-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .role-title {
            font-family: var(--font-display);
            font-size: 18px;
            color: var(--color-accent-cyan);
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 8px;
            color: var(--color-text-primary);
            font-family: var(--font-mono);
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--color-accent-cyan);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        input::placeholder {
            color: var(--color-text-secondary);
        }

        .btn {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, var(--color-accent-cyan), var(--color-accent-green));
            border: none;
            border-radius: 8px;
            color: var(--color-bg-primary);
            font-family: var(--font-display);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Game HUD */
        .game-hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            z-index: 100;
            display: none;
        }

        .game-hud.active {
            display: block;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }

        .hud-panel {
            padding: 15px 25px;
            min-width: 200px;
        }

        .hud-label {
            font-family: var(--font-display);
            font-size: 10px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .hud-value {
            font-family: var(--font-mono);
            font-size: 24px;
            font-weight: 700;
            color: var(--color-accent-cyan);
        }

        .health-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-accent-green), var(--color-accent-cyan));
            transition: width 0.5s ease, background 0.3s ease;
            box-shadow: 0 0 10px currentColor;
        }

        .health-fill.warning {
            background: linear-gradient(90deg, var(--color-warning), var(--color-accent-cyan));
        }

        .health-fill.danger {
            background: linear-gradient(90deg, var(--color-danger), var(--color-warning));
        }

        .attack-meter {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
        }

        .attack-pip {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .attack-pip.active {
            background: var(--color-danger);
            border-color: var(--color-danger);
            box-shadow: 0 0 10px var(--color-danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Lifeline Icons */
        .lifeline-icon {
            width: 30px;
            height: 30px;
            background: var(--color-accent-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 0 10px var(--color-accent-green);
            transition: all 0.3s ease;
        }

        .lifeline-icon.used {
            background: #333;
            box-shadow: none;
            opacity: 0.3;
        }

        /* Main Game Container */
        .game-container {
            display: none;
            padding: 120px 20px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .game-container.active {
            display: block;
        }

        .level-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .level-number {
            font-family: var(--font-display);
            font-size: 14px;
            color: var(--color-accent-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .level-title {
            font-family: var(--font-display);
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .level-description {
            color: var(--color-text-secondary);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Level Content Area */
        .level-content {
            min-height: 500px;
            margin: 30px 0;
        }

        /* Network Visualization */
        .network-canvas {
            width: 100%;
            height: 600px;
            border-radius: 12px;
            cursor: crosshair;
        }

        .network-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 12px 24px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--color-accent-cyan);
            border-radius: 6px;
            color: var(--color-accent-cyan);
            font-family: var(--font-mono);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .control-btn.active {
            background: var(--color-accent-cyan);
            color: var(--color-bg-primary);
        }

        /* SIEM Log Panel */
        .siem-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .log-viewer {
            height: 500px;
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 13px;
            overflow-y: auto;
            background: var(--color-bg-primary);
            border-radius: 12px;
        }

        .log-line {
            padding: 8px 12px;
            margin: 4px 0;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            animation: logAppear 0.3s ease;
        }

        @keyframes logAppear {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-line:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .log-line.info {
            color: var(--color-accent-green);
            border-left-color: var(--color-accent-green);
        }

        .log-line.warn {
            color: var(--color-warning);
            border-left-color: var(--color-warning);
            background: rgba(255, 170, 0, 0.05);
        }

        .log-line.critical {
            color: var(--color-danger);
            border-left-color: var(--color-danger);
            background: rgba(255, 68, 68, 0.1);
            font-weight: 700;
        }

        .log-line.selected {
            background: rgba(0, 255, 136, 0.2);
            border-left-color: var(--color-accent-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .timeline-builder {
            padding: 20px;
        }

        .timeline-builder h3 {
            font-family: var(--font-display);
            font-size: 14px;
            color: var(--color-accent-cyan);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .timeline-events {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .timeline-event {
            padding: 12px;
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid var(--color-accent-cyan);
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 11px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* OSINT Investigation Panel */
        .osint-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .osint-panel {
            padding: 25px;
            min-height: 250px;
        }

        .osint-panel h3 {
            font-family: var(--font-display);
            font-size: 14px;
            color: var(--color-accent-cyan);
            margin-bottom: 20px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding-bottom: 10px;
        }

        .info-field {
            margin-bottom: 15px;
        }

        .info-label {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--color-accent-green);
            padding: 8px 12px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .lookup-btn {
            width: 100%;
            padding: 12px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--color-accent-cyan);
            border-radius: 6px;
            color: var(--color-accent-cyan);
            font-family: var(--font-mono);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .lookup-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .lookup-btn.completed {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--color-accent-green);
            color: var(--color-accent-green);
        }

        /* Terminal */
        .terminal-container {
            padding: 20px;
            background: var(--color-bg-primary);
            border-radius: 12px;
            font-family: var(--font-mono);
            min-height: 400px;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        .terminal-title {
            font-family: var(--font-display);
            font-size: 12px;
            color: var(--color-accent-cyan);
            text-transform: uppercase;
        }

        .threat-indicators {
            display: flex;
            gap: 10px;
        }

        .threat-badge {
            padding: 4px 12px;
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--color-danger);
            border-radius: 12px;
            font-size: 10px;
            color: var(--color-danger);
            text-transform: uppercase;
            animation: pulse 2s infinite;
        }

        .terminal-output {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            color: var(--color-accent-green);
            font-size: 13px;
        }

        .terminal-line {
            margin: 5px 0;
            line-height: 1.6;
        }

        .terminal-input-area {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 212, 255, 0.05);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .terminal-prompt {
            color: var(--color-accent-cyan);
            font-weight: 700;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--color-accent-green);
            font-family: var(--font-mono);
            font-size: 13px;
            outline: none;
        }

        .terminal-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* Boss Fight Layout */
        .boss-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .boss-panel {
            padding: 20px;
            min-height: 250px;
        }

        .mini-terminal {
            height: 150px;
            background: var(--color-bg-primary);
            border-radius: 8px;
            padding: 15px;
            font-family: var(--font-mono);
            font-size: 11px;
            overflow-y: auto;
            color: var(--color-accent-green);
            margin-top: 10px;
        }

        .quick-scan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .quick-node {
            aspect-ratio: 1;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .quick-node:hover {
            border-color: var(--color-accent-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .quick-node.threat {
            border-color: rgba(255, 68, 68, 0.5);
            background: rgba(255, 68, 68, 0.1);
        }

        .quick-node.scanned {
            border-color: var(--color-accent-green);
            background: rgba(0, 255, 136, 0.1);
        }

        .node-icon {
            font-size: 32px;
        }

        .node-label {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--color-text-secondary);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .action-btn {
            padding: 15px 32px;
            font-family: var(--font-display);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--color-accent-cyan), var(--color-accent-green));
            border-color: var(--color-accent-green);
            color: var(--color-bg-primary);
        }

        .action-btn.primary:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: transparent;
            border-color: var(--color-accent-cyan);
            color: var(--color-accent-cyan);
        }

        .action-btn.secondary:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Results Screen */
        .results-screen {
            display: none;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .results-screen.active {
            display: flex;
        }

        .results-container {
            max-width: 800px;
            width: 100%;
            padding: 60px 40px;
            text-align: center;
        }

        .results-rank {
            font-size: 120px;
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .results-title {
            font-family: var(--font-display);
            font-size: 48px;
            font-weight: 900;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .results-subtitle {
            font-size: 20px;
            color: var(--color-text-secondary);
            margin-bottom: 40px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 40px 0;
        }

        .stat-box {
            padding: 25px;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 48px;
            font-weight: 900;
            color: var(--color-accent-cyan);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .performance-message {
            padding: 30px;
            margin: 30px 0;
            border-left: 4px solid;
        }

        .performance-message p {
            font-size: 16px;
            line-height: 1.8;
            color: var(--color-text-secondary);
        }

        /* Admin Dashboard */
        .admin-screen {
            display: none;
            padding: 40px 20px;
        }

        .admin-screen.active {
            display: block;
        }

        .admin-header {
            max-width: 1400px;
            margin: 0 auto 40px;
            padding: 30px;
            border-left: 4px solid var(--color-warning);
        }

        .admin-header h1 {
            font-family: var(--font-display);
            font-size: 32px;
            color: var(--color-warning);
            margin-bottom: 10px;
        }

        .admin-grid {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .admin-card {
            padding: 25px;
        }

        .admin-card h2 {
            font-family: var(--font-display);
            font-size: 16px;
            color: var(--color-accent-cyan);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 212, 255, 0.05);
            border-left: 3px solid var(--color-accent-cyan);
            border-radius: 6px;
        }

        .student-name {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--color-text-primary);
            margin-bottom: 8px;
        }

        .student-stats {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .approval-item {
            padding: 20px;
            margin: 15px 0;
            background: rgba(255, 170, 0, 0.1);
            border-left: 3px solid var(--color-warning);
            border-radius: 6px;
        }

        .drawing-preview {
            width: 100%;
            max-width: 300px;
            border: 2px solid var(--color-accent-cyan);
            border-radius: 8px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .drawing-preview:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }

        .approve-btn {
            padding: 10px 20px;
            background: var(--color-accent-green);
            color: var(--color-bg-primary);
            border: none;
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .approve-btn:hover {
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .notification {
            padding: 20px 30px;
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            border-left: 4px solid;
            font-family: var(--font-mono);
            font-size: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: notifSlide 0.3s ease;
            pointer-events: all;
            max-width: 400px;
        }

        @keyframes notifSlide {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left-color: var(--color-accent-green);
        }

        .notification.error {
            border-left-color: var(--color-danger);
        }

        .notification.info {
            border-left-color: var(--color-accent-cyan);
        }

        .notification.warning {
            border-left-color: var(--color-warning);
        }

        /* Modal */
        .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow: auto !important;
}


        .modal.active {
            display: flex;
        }

       .modal-content {
    max-width: 95%;
    max-height: 95vh;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--color-danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            transform: rotate(90deg);
            box-shadow: 0 0 20px var(--color-danger);
        }

        /* Drawing Canvas */
        .drawing-container {
            text-align: center;
        }

        .drawing-canvas {
            background: white;
            border: 3px solid var(--color-accent-cyan);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
            cursor: crosshair;
            margin: 20px auto;
            display: block;
        }

        .drawing-tools {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .tool-btn {
            padding: 10px 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--color-accent-cyan);
            border-radius: 6px;
            color: var(--color-accent-cyan);
            font-family: var(--font-mono);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .tool-btn.active {
            background: var(--color-accent-cyan);
            color: var(--color-bg-primary);
        }

        .drawing-instructions {
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--color-accent-cyan);
        }

        .drawing-instructions ul {
            list-style: none;
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .drawing-instructions li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .drawing-instructions li::before {
            content: '‚ñ∏';
            position: absolute;
            left: 0;
            color: var(--color-accent-cyan);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-title h1 {
                font-size: 32px;
            }

            .role-selection {
                grid-template-columns: 1fr;
            }

            .hud-top {
                flex-direction: column;
            }

            .siem-container {
                grid-template-columns: 1fr;
            }

            .osint-grid {
                grid-template-columns: 1fr;
            }

            .boss-grid {
                grid-template-columns: 1fr;
            }

            .results-stats {
                grid-template-columns: 1fr;
            }

            .admin-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top-color: var(--color-accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 20px 30px;
            background: var(--color-glass);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 2px solid var(--color-accent-green);
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.4);
            z-index: 1001;
            animation: achievementSlide 0.5s ease;
            pointer-events: none;
        }

        @keyframes achievementSlide {
            from {
                transform: translateX(500px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .achievement-title {
            font-family: var(--font-display);
            font-size: 16px;
            color: var(--color-accent-green);
            text-transform: uppercase;
        }

        /* Drawing Tools */
        .drawing-container {
            padding: 20px;
        }

        .tool-btn {
            padding: 10px 20px;
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Rajdhani', sans-serif;
        }

        .tool-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .tool-btn.active {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .tool-btn:active {
            transform: translateY(0);
        }

        /* Scrollbar Customization */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="grid-background"></div>
    <div class="scanlines"></div>
    
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Home/Enrollment Screen -->
        <div class="login-screen active" id="homeScreen">
            <div class="login-container" style="max-width: 1200px;">
                <div class="game-title">
                    <h1>CYBERQUEST</h1>
                    <p class="game-subtitle">Operation Digital Shield v2.0</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px;">
                    <!-- Enrollment Section -->
                    <div class="glass-panel" style="padding: 30px;">
                        <h2 style="color: var(--color-accent-cyan); margin-bottom: 20px; font-size: 24px;">
                            üéØ TEAM ENROLLMENT
                        </h2>
                        
                        <div class="role-selection" style="margin-bottom: 20px;">
                            <div class="glass-panel role-card active" data-role="analyst" onclick="selectRole('analyst')" style="margin: 0; padding: 20px;">
                                <div class="role-icon" style="font-size: 36px;">üõ°Ô∏è</div>
                                <div class="role-title">Security Analyst</div>
                            </div>
                            <div class="glass-panel role-card" data-role="admin" onclick="selectRole('admin')" style="margin: 0; padding: 20px;">
                                <div class="role-icon" style="font-size: 36px;">üë®‚Äçüíº</div>
                                <div class="role-title">Instructor</div>
                            </div>
                        </div>

                        <div id="analystLogin">
                            <input type="text" id="teamName" placeholder="TEAM NAME" autocomplete="off" onkeydown="if(event.key==='Enter') document.getElementById('analystName').focus()">
                            <input type="text" id="analystName" placeholder="PLAYER NAME" autocomplete="off" onkeydown="if(event.key==='Enter') enrollTeam()">
                            <button class="btn" onclick="enrollTeam()">‚úÖ ENROLL & START GAME</button>
                        </div>

                        <div id="adminLogin" style="display: none;">
                            <input type="password" id="adminPassword" placeholder="INSTRUCTOR ACCESS CODE" autocomplete="off" onkeydown="if(event.key==='Enter') adminLogin()">
                            <button class="btn" onclick="adminLogin()">üîê ACCESS INSTRUCTOR PANEL</button>
                            <p style="color: #6b7280; font-size: 12px; margin-top: 10px; text-align: center;">
                             <!--   Default password: cybersec2025 -->
                            </p>
                        </div>
                    </div>

                    <!-- Live Leaderboard Section -->
                    <div class="glass-panel" style="padding: 30px;">
                        <h2 style="color: var(--color-accent-green); margin-bottom: 20px; font-size: 24px;">
                            üèÜ LIVE LEADERBOARD
                        </h2>
                        <div id="leaderboardList" style="max-height: 400px; overflow-y: auto;">
                            <p style="color: #6b7280; text-align: center; padding: 40px;">
                                No teams enrolled yet. Be the first!
                            </p>
                        </div>
                        <button class="btn" onclick="refreshLeaderboard()" style="margin-top: 20px; background: rgba(0, 212, 255, 0.2);">
                            üîÑ REFRESH
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mission Brief Screen -->
        <div class="login-screen" id="briefingScreen">
            <div class="login-container">
                <div class="game-title">
                    <h1>MISSION BRIEFING</h1>
                </div>

                <div class="glass-panel mission-brief">
                    <h2>‚ö†Ô∏è CRITICAL SECURITY INCIDENT</h2>
                    <p><strong>STATUS:</strong> ACTIVE BREACH IN PROGRESS</p>
                   <p><strong>THREAT ACTOR:</strong> <span id="briefingAttacker">Detecting...</span> (<span id="briefingIP">Loading...</span>)</p>
                    <p><strong>TARGET:</strong> Employee Account (<span id="briefingPlayer">Loading...</span>)</p>
                    <p><strong>ATTACK TYPE:</strong> Brute Force ‚Üí Account Compromise ‚Üí Data Exfiltration</p>
                    <p><strong>SECURITY HEALTH:</strong> 100% (Degrading)</p>
                    <p><strong>YOUR MISSION:</strong> Investigate, contain, and neutralize the threat before critical data is stolen.</p>
                </div>

                <div class="action-buttons" style="margin-top: 30px;">
                    <button class="action-btn primary" onclick="startMission()">‚ö° ACCEPT MISSION</button>
                </div>
            </div>
        </div>

        <!-- Game HUD -->
        <div class="game-hud" id="gameHUD">
            <div class="hud-top">
                <div class="glass-panel hud-panel">
                    <div class="hud-label">Security Health</div>
                    <div class="hud-value" id="healthValue">100%</div>
                    <div class="health-bar">
                        <div class="health-fill" id="healthFill" style="width: 100%"></div>
                    </div>
                </div>

                <div class="glass-panel hud-panel">
                    <div class="hud-label">Mission Progress</div>
                    <div class="hud-value" id="levelProgress">LEVEL 1/5</div>
                </div>

                <div class="glass-panel hud-panel">
                    <div class="hud-label">Attack Intensity</div>
                    <div class="attack-meter" id="attackMeter">
                        <div class="attack-pip"></div>
                        <div class="attack-pip"></div>
                        <div class="attack-pip"></div>
                        <div class="attack-pip"></div>
                        <div class="attack-pip"></div>
                    </div>
                </div>

                <div class="glass-panel hud-panel">
                    <div class="hud-label">Current Score</div>
                    <div class="hud-value" id="scoreValue">0</div>
                </div>

                <div class="glass-panel hud-panel">
                    <div class="hud-label">Lifelines</div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <div class="lifeline-icon" id="life1">üíö</div>
                        <div class="lifeline-icon" id="life2">üíö</div>
                        <div class="lifeline-icon" id="life3">üíö</div>
                    </div>
                </div>

                <div class="glass-panel hud-panel">
                    <div class="hud-label">Mistakes</div>
                    <div class="hud-value" id="mistakeCount">0</div>
                </div>
            </div>
        </div>

        <!-- Game Container -->
        <div class="game-container" id="gameContainer">
            <div class="level-header">
                <div class="level-number" id="levelNumber">LEVEL 01</div>
                <h2 class="level-title" id="levelTitle">NETWORK RECONNAISSANCE</h2>
                <p class="level-description" id="levelDescription">Scan the network and identify active threats</p>
            </div>

            <div class="glass-panel level-content" id="levelContent">
                <!-- Content will be dynamically loaded here -->
            </div>

            <div class="action-buttons">
                <button class="action-btn" id="lifelineBtn" onclick="useLifeline()" style="display: none; background: linear-gradient(135deg, #ff6b6b, #ff8e53); border-color: #ff6b6b; color: white;">
                    üí° USE LIFELINE (<span id="lifelineCount">3</span>)
                </button>
                <button class="action-btn secondary" onclick="showHelp()">‚ùì HELP</button>
                <button class="action-btn primary" id="completeBtn" onclick="completeLevel()" disabled>‚úì COMPLETE LEVEL</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="glass-panel results-container">
                <div class="results-rank" id="resultsRank">üèÜ LEGENDARY</div>
                <h2 class="results-title" id="resultsTitle">MISSION COMPLETE</h2>
                <p class="results-subtitle" id="resultsSubtitle">Final Performance Assessment</p>

                <div class="results-stats">
                    <div class="glass-panel stat-box">
                        <div class="stat-value" id="finalScore">0</div>
                        <div class="stat-label">Final Score</div>
                    </div>
                    <div class="glass-panel stat-box">
                        <div class="stat-value" id="finalHealth">0%</div>
                        <div class="stat-label">Security Health</div>
                    </div>
                    <div class="glass-panel stat-box">
                        <div class="stat-value" id="evidenceCollected">0</div>
                        <div class="stat-label">Evidence Collected</div>
                    </div>
                </div>

                <div class="glass-panel performance-message" id="performanceMessage">
                    <p></p>
                </div>

                <div class="action-buttons">
                    <button class="action-btn secondary" onclick="downloadCertificate()">üìú DOWNLOAD CERTIFICATE</button>
                    <button class="action-btn secondary" onclick="viewReport()">üìä VIEW DETAILED REPORT</button>
                    <button class="action-btn primary" onclick="playAgain()">üîÑ NEW OPERATION</button>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div class="admin-screen" id="adminScreen">
            <div class="glass-panel admin-header">
                <h1>üîë INSTRUCTOR COMMAND CENTER</h1>
                <p style="color: var(--color-text-secondary);">Real-time student monitoring and approval system</p>
            </div>

            <div class="admin-grid">
                <div class="admin-grid">
    <div style="display: flex; flex-direction: column; gap: 30px; width: 100%; max-width: 100%;">
    <!-- Active Analysts -->
    <div class="glass-panel" style="padding: 30px; width: 100%;">
        <h2 style="color: var(--color-accent-cyan); margin-bottom: 20px; font-size: 20px;">üìä Active Analysts</h2>
        <div class="student-list" id="studentList">
            <p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No active sessions</p>
        </div>
    </div>
    
    <!-- Blocked Analysts -->
    <div class="glass-panel" style="padding: 30px; width: 100%;">
        <h2 style="color: var(--color-danger); margin-bottom: 20px; font-size: 20px;">üîí Blocked Analysts</h2>
        <div class="student-list" id="blockedList">
            <p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No blocked analysts</p>
        </div>
    </div>
    
    <!-- Completed Analysts -->
    <div class="glass-panel" style="padding: 30px; width: 100%;">
        <h2 style="color: var(--color-accent-green); margin-bottom: 20px; font-size: 20px;">üéì Completed Analysts</h2>
        <div class="student-list" id="completedList">
            <p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No completed analysts</p>
        </div>
    </div>
    
    <!-- Pending Approvals -->
    <div class="glass-panel" style="padding: 30px; width: 100%;">
        <h2 style="color: var(--color-warning); margin-bottom: 20px; font-size: 20px;">‚è≥ Pending Approvals</h2>
        <div class="student-list" id="approvalList">
            <p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No pending approvals</p>
        </div>
    </div>
</div>




               <div class="glass-panel admin-card">
    <h2>System Controls</h2>
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <button class="btn" onclick="refreshDashboard()" style="background: rgba(0, 212, 255, 0.2);">üîÑ REFRESH DATA</button>
        <button class="btn" onclick="exportData()" style="background: rgba(0, 255, 136, 0.2);">üìä EXPORT REPORTS</button>
        <button class="btn" onclick="exportAnalysts()" style="background: rgba(0, 255, 200, 0.2);">üì• EXPORT ANALYSTS</button>
        <button class="btn" onclick="unlockAllAccounts()" style="background: rgba(0, 255, 136, 0.3);">üîì UNBLOCK ALL ANALYSTS</button>
        <button class="btn" onclick="resetAll()" style="background: rgba(255, 68, 68, 0.2);">üóëÔ∏è RESET ALL PROGRESS</button>
        <button class="btn" onclick="logoutAdmin()" style="background: rgba(255, 170, 0, 0.2);">üö™ LOGOUT</button>
    </div>
</div>

            </div>
        </div>
    </div>

    <!-- Modal for Drawing Preview -->
    <div class="modal" id="drawingModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <img id="modalImage" style="max-width: 100%; border-radius: 12px; border: 3px solid var(--color-accent-cyan);">
        </div>
    </div>
<!-- ‚úÖ COPYRIGHT FOOTER -->
    <footer style=" bottom: 0; left: 0; width: 100%; 
                   background: linear-gradient(135deg, rgba(10, 14, 39, 0.95), rgba(26, 31, 58, 0.95)); 
                   backdrop-filter: blur(10px);
                   border-top: 1px solid rgba(0, 212, 255, 0.2);
                   padding: 15px 20px;
                   text-align: center;
                   z-index: 1000;
                   box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span style="color: #9ca3af; font-size: 14px; font-family: var(--font-mono);">
                ¬© 2026 CyberQuest Security Training
            </span>
            <span style="color: #00d4ff; font-size: 14px;">‚Ä¢</span>
            <span style="color: #fff; font-size: 14px; font-family: var(--font-mono); display: flex; align-items: center; gap: 8px;">
                Powered by 
                <!--<img src="data:image/png;base64,YOUR_CSS_LOGO_BASE64" 
                     alt="CSS Logo" 
                     style="height: 24px; vertical-align: middle;"> -->
                <strong style="color: #00ff88;">Codespace Solutions</strong>
            </span>
            <span style="color: #00d4ff; font-size: 14px;">‚Ä¢</span>
            <span style="color: #9ca3af; font-size: 12px;">
                Coimbatore, 641062
            </span>
        </div>
    </footer>

    <script>


// ‚úÖ REPLACE Base64 constants with:
//const CERTIFICATE_IMAGE_BASE64 = './images/certificate.jpeg';
//const SIGNATURE_IMAGE_BASE64 = './images/signature.jpeg';



        // ==================== GAME ENGINE ====================
        
        const ADMIN_PASSWORD = 'cybersec2025';
        
// Function to get user's actual IP address
async function getSystemIP() {
    try {
        // Try to get actual IP
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('Could not fetch IP:', error);
        // Fallback to a default if fetch fails
        return '192.168.1.45';
    }
}


// Store the system IP globally
let SYSTEM_IP = '192.168.1.45'; // Default

// ‚úÖ FETCH REAL IP IMMEDIATELY ON PAGE LOAD
(async function fetchRealIP() {
    try {
        console.log('üîç Fetching real IPv4 address...');
        const response = await fetch('https://api.ipify.org?format=json', {
            method: 'GET',
            cache: 'no-cache'
        });
        const data = await response.json();
        SYSTEM_IP = data.ip;
        console.log('‚úÖ Real System IPv4 detected:', SYSTEM_IP);
        
        // Update gameState if already initialized
        if (typeof gameState !== 'undefined' && gameState) {
            gameState.systemIP = SYSTEM_IP;
            console.log('‚úÖ Updated gameState.systemIP:', gameState.systemIP);
        }
    } catch (error) {
        console.error('‚ùå Could not fetch real IP, using default:', error);
        SYSTEM_IP = '192.168.1.45';
    }
})();




        // Reference diagram for instructor to compare
        const REFERENCE_DIAGRAM_URL = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjQwMCIgeT0iNTAiIGZvbnQtc2l6ZT0iMjQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMzMzIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5SRUZBQ1JFTkNFIERJQUdSQU08L3RleHQ+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMzAwIiByPSI0MCIgZmlsbD0iIzAwZDRmZiIgc3Ryb2tlPSIjMDA4OGNjIiBzdHJva2Utd2lkdGg9IjMiLz48dGV4dCB4PSIxMDAiIHk9IjMwNSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+MkDwvdGV4dD48dGV4dCB4PSIxMDAiIHk9IjM2MCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW50ZXJuZXQ8L3RleHQ+PGNpcmNsZSBjeD0iMjUwIiBjeT0iMzAwIiByPSI0MCIgZmlsbD0iI2ZmODgwMCIgc3Ryb2tlPSIjY2M2NjAwIiBzdHJva2Utd2lkdGg9IjMiLz48dGV4dCB4PSIyNTAiIHk9IjMwNSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+UpTwvdGV4dD48dGV4dCB4PSIyNTAiIHk9IjM2MCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RmlyZXdhbGw8L3RleHQ+PGNpcmNsZSBjeD0iNDAwIiBjeT0iMjAwIiByPSI0MCIgZmlsbD0iIzAwZmY4OCIgc3Ryb2tlPSIjMDBjYzY2IiBzdHJva2Utd2lkdGg9IjMiLz48dGV4dCB4PSI0MDAiIHk9IjIwNSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+UkDwvdGV4dD48dGV4dCB4PSI0MDAiIHk9IjI2MCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QXV0aCBTZXJ2ZXI8L3RleHQ+PGNpcmNsZSBjeD0iNTUwIiBjeT0iMzAwIiByPSI0MCIgZmlsbD0iI2ZmNDQ0NCIgc3Ryb2tlPSIjY2MwMDAwIiBzdHJva2Utd2lkdGg9IjMiLz48dGV4dCB4PSI1NTAiIHk9IjMwNSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+SuzwvdGV4dD48dGV4dCB4PSI1NTAiIHk9IjM2MCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VXNlciBQQyAjMTwvdGV4dD48dGV4dCB4PSI1NTAiIHk9IjM3OCIgZm9udC1zaXplPSIxMiIgZmlsbD0iI2ZmNDQ0NCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Q09NUFJPTUJTRUQ8L3RleHQ+PGNpcmNsZSBjeD0iNTUwIiBjeT0iNDUwIiByPSI0MCIgZmlsbD0iIzAwZmY4OCIgc3Ryb2tlPSIjMDBjYzY2IiBzdHJva2Utd2lkdGg9IjMiLz48dGV4dCB4PSI1NTAiIHk9IjQ1NSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+SuzwvdGV4dD48dGV4dCB4PSI1NTAiIHk9IjUxMCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VXNlciBQQyAjMjwvdGV4dD48Y2lyY2xlIGN4PSI3MDAiIGN5PSIzMDAiIHI9IjQwIiBmaWxsPSIjZmY0NDQ0IiBzdHJva2U9IiNjYzAwMDAiIHN0cm9rZS13aWR0aD0iMyIvPjx0ZXh0IHg9IjcwMCIgeT0iMzA1IiBmb250LXNpemU9IjMyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7imqDvuI88L3RleHQ+PHRleHQgeD0iNzAwIiB5PSIzNjAiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiMzMzMiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkF0dGFja2VyPC90ZXh0Pjx0ZXh0IHg9IjcwMCIgeT0iMzc4IiBmb250LXNpemU9IjEyIiBmaWxsPSIjZmY0NDQ0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5MYWdvcywgTmlnZXJpYTwvdGV4dD48bGluZSB4MT0iMTQwIiB5MT0iMzAwIiB4Mj0iMjEwIiB5Mj0iMzAwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMyIvPjxsaW5lIHgxPSIyOTAiIHkxPSIzMDAiIHgyPSIzNjAiIHkyPSIyMjAiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSIzIi8+PGxpbmUgeDE9IjQ0MCIgeTE9IjIyMCIgeDI9IjUxMCIgeTI9IjI4MCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjMiLz48bGluZSB4MT0iNTkwIiB5MT0iMzAwIiB4Mj0iNjYwIiB5Mj0iMzAwIiBzdHJva2U9IiNmZjQ0NDQiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWRhc2hhcnJheT0iMTAiLz48dGV4dCB4PSI0MDAiIHk9IjU1MCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmNDQ0NCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UmVkIEFycm93ID0gQXR0YWNrIFBhdGg8L3RleHQ+PC9zdmc+';
        const ENDING_THRESHOLDS = {
            CATASTROPHIC: 200,
            POOR: 400,
            ADEQUATE: 600,
            EXCELLENT: 800,
            PERFECT: 1000
        };

        // Game State
        const gameState = {
            role: 'analyst',
            team: '',
            player: '',
            currentLevel: 1,
            score: 0,
            health: 100,
            systemIP: SYSTEM_IP,  // Store system IP
    startTime: Date.now(),
    lastUpdate: Date.now(),

            lifelines: 3,
            wrongClicks: 0,
            lastAction: null,
            isBanned: false,
            attackIntensity: 1,
            evidence: [],
            levelsCompleted: [],
            startTime: null,
            endTime: null,
            mistakes: 0,
            achievements: [],
            pendingApproval: null
        };

        // Level Definitions
        const levels = [
            {
                id: 1,
                number: '01',
                title: 'NETWORK RECONNAISSANCE',
                description: 'Scan THREATS first, then other nodes. Wrong order reduces health!',
                type: 'network',
                maxScore: 200,
                completionScore: 100
            },
            {
                id: 2,
                number: '02',
                title: 'LOG FORENSICS',
                description: 'Click CRITICAL logs first, then WARN. Order matters!',
                type: 'logs',
                maxScore: 300,
                completionScore: 150
            },
            {
                id: 3,
                number: '03',
                title: 'ATTACK VISUALIZATION',
                description: 'Draw complete diagram with ALL labels',
                type: 'drawing',
                maxScore: 250,
                needsApproval: true,
                completionScore: 100
            },
            {
                id: 4,
                number: '04',
                title: 'THREAT INTELLIGENCE',
                description: 'Beware of decoys! Choose carefully.',
                type: 'osint',
                maxScore: 200,
                completionScore: 100
            },
            {
                id: 5,
                number: '05',
                title: 'FINAL DEFENSE',
                description: 'Execute EXACT commands in correct order',
                type: 'boss',
                maxScore: 300,
                completionScore: 200
            }
        ];

        // ==================== INITIALIZATION ====================
        
        function initGame() {
            updateHUD();
            loadLeaderboard();
            startApprovalPolling();
        }

        // ==================== ENROLLMENT & LEADERBOARD ====================
        
              // ENROLLMENT & LEADERBOARD
        function enrollTeam() {
    const team = document.getElementById('teamName').value.trim();
    const player = document.getElementById('analystName').value.trim();
    
    if (!team || !player) {
        showNotification('‚ö†Ô∏è Please enter team name and player name', 'error');
        return;
    }
    
    gameState.team = team;
    gameState.player = player;
    
    // ‚úÖ CHECK IF EXISTING ACCOUNT EXISTS
    const savedData = loadProgress();
    
    if (savedData) {
        // Load existing progress
        Object.assign(gameState, savedData);
        
        // ‚úÖ CHECK IF ACCOUNT IS BANNED/LOCKED
        if (savedData.isBanned) {
            showNotification('üîí Account is locked! Contact instructor.', 'error');
            showBanScreen();
            return; // Stop enrollment
        }
        
        // ‚úÖ CHECK IF GAME COMPLETED (All 5 levels done)
        if (savedData.currentLevel > 5 || savedData.levelsCompleted.length === 5) {
            showNotification('‚úì Game already completed! Showing certificate...', 'success');
            showResults(); // Show certificate directly
            return;
        }
        
        // ‚úÖ RESUME GAME - Skip briefing, go directly to current level
        showNotification(`‚úì Welcome back ${player}! Resuming Level ${savedData.currentLevel}...`, 'success');
        
        // Hide home screen, show game directly
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('briefingScreen').classList.remove('active');
        document.getElementById('gameHUD').classList.add('active');
        document.getElementById('gameContainer').classList.add('active');
        
        // Load current level
        loadLevel(savedData.currentLevel);
        playSound('start');
        
    } else {
        // ‚úÖ NEW ACCOUNT - Initialize fresh
        gameState.startTime = Date.now();
        gameState.systemIP = SYSTEM_IP;
        console.log('‚úÖ New account IP saved:', gameState.systemIP); // Debug
        // Save to leaderboard
        saveToLeaderboard();
        
        // Show briefing screen for new players
        document.getElementById('homeScreen').classList.remove('active');
        document.getElementById('briefingScreen').classList.add('active');
        
        showNotification(`‚úì ${team} enrolled! Welcome ${player}!`, 'success');
    }
}
function showResults() {
    gameState.endTime = Date.now();
    saveProgress();
    
    // Hide game screens
    document.getElementById('gameHUD').classList.remove('active');
    document.getElementById('gameContainer').classList.remove('active');
    
    // Show results screen
    document.getElementById('resultsScreen').classList.add('active');
    
    // ‚úÖ CALL displayResults to populate data
    displayResults();
    
    playSound('victory');
}


        function saveToLeaderboard() {
    let leaderboard = JSON.parse(localStorage.getItem('cyberquest_leaderboard') || '[]');
    
    const entry = {
        team: gameState.team,
        player: gameState.player,
        score: gameState.score,
        health: gameState.health,
        level: gameState.currentLevel,
        startTime: gameState.startTime,
        lastUpdate: Date.now()
    };
    
    // Update or add
    const index = leaderboard.findIndex(e => e.team === gameState.team && e.player === gameState.player);
    if (index >= 0) {
        leaderboard[index] = entry;
    } else {
        leaderboard.push(entry);
    }
    
    localStorage.setItem('cyberquest_leaderboard', JSON.stringify(leaderboard));
    loadLeaderboard();
}

function loadLeaderboard() {
    const leaderboard = JSON.parse(localStorage.getItem('cyberquest_leaderboard') || '[]');
    const container = document.getElementById('leaderboardList');
    
    if (leaderboard.length === 0) {
        container.innerHTML = `<p style="color: #6b7280; text-align: center; padding: 40px">No teams enrolled yet. Be the first!</p>`;
        return;
    }
    
    // Sort by score descending
    leaderboard.sort((a, b) => b.score - a.score);
    
    container.innerHTML = leaderboard.map((entry, index) => `
        <div class="glass-panel" style="padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center">
            <div style="display: flex; align-items: center; gap: 15px">
                <div style="font-size: 24px; font-weight: bold; color: ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#6b7280'}">${index + 1}</div>
                <div>
                    <div style="font-weight: bold; color: var(--color-accent-cyan)">${entry.team}</div>
                    <div style="font-size: 12px; color: #9ca3af">${entry.player}</div>
                </div>
            </div>
            <div style="text-align: right">
                <div style="font-weight: bold; color: var(--color-accent-green); font-size: 18px">${entry.score} pts</div>
                <div style="font-size: 12px; color: #9ca3af">Level ${entry.level}/5 ‚Ä¢ ${entry.health}% HP</div>
            </div>
        </div>
    `).join('');
}

        function loadLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('cyberquest_leaderboard') || '[]');
            const container = document.getElementById('leaderboardList');

            if (leaderboard.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 40px;">No teams enrolled yet. Be the first!</p>';
                return;
            }

            // Sort by score descending
            leaderboard.sort((a, b) => b.score - a.score);

            container.innerHTML = leaderboard.map((entry, index) => `
                <div class="glass-panel" style="padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 24px; font-weight: bold; color: ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#6b7280'};">
                            ${index + 1}
                        </div>
                        <div>
                            <div style="font-weight: bold; color: var(--color-accent-cyan);">${entry.team}</div>
                         
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: var(--color-accent-green); font-size: 18px;">${entry.score} pts</div>
                        <div style="font-size: 12px; color: #9ca3af;">Level ${entry.level}/5 ‚Ä¢ ${entry.health}% HP</div>
                    </div>
                </div>
            `).join('');
        }

        function refreshLeaderboard() {
            loadLeaderboard();
            showNotification('‚úì Leaderboard refreshed', 'success');
        }

        // ==================== ROLE SELECTION ====================
        
        function selectRole(role) {
            gameState.role = role;
            
            // Remove active class from all cards
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Add active to the selected card
            document.querySelector(`.role-card[data-role="${role}"]`).classList.add('active');

            if (role === 'analyst') {
                document.getElementById('analystLogin').style.display = 'block';
                document.getElementById('adminLogin').style.display = 'none';
            } else {
                document.getElementById('analystLogin').style.display = 'none';
                document.getElementById('adminLogin').style.display = 'block';
            }
        }

       // ==================== START MISSION ====================
        
        function startMission() {
            if (!gameState.team || !gameState.player) {
                showNotification('‚ö†Ô∏è Please enroll first', 'error');
                return;
            }
// ‚úÖ CHECK IF ALREADY COMPLETED ALL 5 LEVELS
    // ‚úÖ CHECK IF ALREADY COMPLETED ALL 5 LEVELS
if (gameState.levelsCompleted && gameState.levelsCompleted.length === 5) {
    showNotification('‚úì Mission already completed! Showing certificate...', 'success');
    
    // Hide briefing screen
    document.getElementById('briefingScreen').classList.remove('active');
    
    // ‚úÖ SHOW RESULTS SCREEN AFTER DELAY
    setTimeout(() => {
        // Make sure end time is set
        if (!gameState.endTime) {
            gameState.endTime = Date.now();
        }
        
        // Show results screen
        document.getElementById('resultsScreen').classList.add('active');
        
        // Display results data
        displayResults();
    }, 500);
    
    return; // Stop here, don't load game
}
// ‚úÖ FORCE UPDATE SYSTEM IP BEFORE STARTING
    if (SYSTEM_IP && SYSTEM_IP !== '192.168.1.45') {
        gameState.systemIP = SYSTEM_IP;
        console.log('‚úÖ System IP updated before mission:', gameState.systemIP);
    }
saveProgress();
            saveToLeaderboard();
            // Get attacker info and update briefing
            const attackerInfo = getAttackerForAnalyst();
            const briefingIP = document.getElementById('briefingIP');
            const briefingPlayer = document.getElementById('briefingPlayer');
            const briefingAttacker = document.getElementById('briefingAttacker');
            
            if (briefingIP) briefingIP.textContent = attackerInfo.ip;
            if (briefingPlayer) briefingPlayer.textContent = gameState.player || 'Unknown';
            if (briefingAttacker) briefingAttacker.textContent = `${attackerInfo.team} - ${attackerInfo.player}`;



            // Load existing progress or start fresh
            const savedData = loadProgress();
            if (savedData && savedData.team === gameState.team && savedData.player === gameState.player) {
                Object.assign(gameState, savedData);
                
                // ‚ö†Ô∏è CHECK IF ACCOUNT IS BANNED/LOCKED
                if (gameState.isBanned) {
                    showNotification('üîí Account is LOCKED! Health reached 0. Contact instructor.', 'error');
                    showBanScreen();
                    return; // STOP - Do not load game
                }
                
                showNotification('‚úì Progress loaded. Mission resuming...', 'success');
            }


            // Transition to game
            document.getElementById('homeScreen').classList.remove('active');
            document.getElementById('briefingScreen').classList.remove('active');
            document.getElementById('gameHUD').classList.add('active');
            document.getElementById('gameContainer').classList.add('active');


            playSound('start');
            loadLevel(gameState.currentLevel);
            
        }
// ‚úÖ DISPLAY RESULTS DATA (for re-login after completion)
function displayResults() {
    // Update result values
    document.getElementById('finalScore').textContent = gameState.score;
    document.getElementById('finalHealth').textContent = gameState.health + '%';
    document.getElementById('evidenceCollected').textContent = gameState.evidence.length;
    
    // Determine rank based on score
    const rank = gameState.score >= 1000 ? 'üèÜ LEGENDARY' :
                 gameState.score >= 800 ? '‚≠ê MASTER' :
                 gameState.score >= 600 ? 'üéñÔ∏è EXPERT' :
                 gameState.score >= 400 ? 'ü•â INTERMEDIATE' :
                 'üìù NOVICE';
    
    document.getElementById('resultsRank').textContent = rank;
    
    // Update title
    document.getElementById('resultsTitle').textContent = 'MISSION COMPLETE';
    document.getElementById('resultsSubtitle').textContent = 'Final Performance Assessment';
    
    // Performance message
    let message = '';
    let endingKey = '';
    
    if (gameState.score >= 1000) {
        endingKey = 'PERFECT';
        message = 'üèÜ PERFECT EXECUTION! You neutralized the threat with exceptional skill and precision.';
    } else if (gameState.score >= 800) {
        endingKey = 'EXCELLENT';
        message = '‚≠ê EXCELLENT WORK! The threat has been contained with minimal damage.';
    } else if (gameState.score >= 600) {
        endingKey = 'ADEQUATE';
        message = 'üéñÔ∏è MISSION ACCOMPLISHED! The threat has been neutralized, though some damage occurred.';
    } else if (gameState.score >= 400) {
        endingKey = 'POOR';
        message = 'ü•â THREAT CONTAINED! Significant damage was incurred during the operation.';
    } else {
        endingKey = 'CATASTROPHIC';
        message = '‚ö†Ô∏è CRITICAL DAMAGE! The breach caused substantial losses before containment.';
    }
    
    document.getElementById('performanceMessage').innerHTML = `<p>${message}</p>`;
    
    console.log('‚úÖ Results displayed:', {
        score: gameState.score,
        health: gameState.health,
        evidence: gameState.evidence.length,
        rank: rank
    });
}

        // ==================== ADMIN LOGIN ====================
        
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;

            if (password === ADMIN_PASSWORD) {
                document.getElementById('homeScreen').classList.remove('active');
                document.getElementById('briefingScreen').classList.remove('active');
                document.getElementById('adminScreen').classList.add('active');
                loadAdminDashboard();
                showNotification('‚úì Instructor access granted', 'success');
            } else {
                showNotification('‚ö†Ô∏è Invalid access code', 'error');
            }
        }

        // ==================== LEVEL LOADING ====================
        
        function loadLevel(levelId) {
            const level = levels.find(l => l.id === levelId);
            if (!level) return;

            // Cleanup previous level animations
            if (networkAnimationFrame) {
                cancelAnimationFrame(networkAnimationFrame);
                networkAnimationFrame = null;
            }
            
            // Reset level-specific tracking variables
            if (levelId === 1) {
                networkScanProgress = 0;
                threatsFound = 0;
            } else if (levelId === 2) {
                selectedLogs = [];
                criticalLogsSelected = 0;
                warnLogsSelected = 0;
            }

            gameState.currentLevel = levelId;
            
            document.getElementById('levelNumber').textContent = `LEVEL ${level.number}`;
            document.getElementById('levelTitle').textContent = level.title;
            document.getElementById('levelDescription').textContent = level.description;
            document.getElementById('levelProgress').textContent = `LEVEL ${levelId}/5`;
            document.getElementById('completeBtn').disabled = true;

            // Increase attack intensity
            gameState.attackIntensity = Math.min(5, levelId);
            updateAttackMeter();

            // Load level content
            const content = document.getElementById('levelContent');
            content.innerHTML = '';

            switch (level.type) {
                case 'network':
                    loadNetworkLevel(content);
                    break;
                case 'logs':
                    loadLogsLevel(content);
                    break;
                case 'drawing':
                    loadDrawingLevel(content);
                    break;
                case 'osint':
                    loadOSINTLevel(content);
                    break;
                case 'terminal':
                    loadTerminalLevel(content);
                    break;
                case 'boss':
                    loadBossLevel(content);
                    break;
            }

            playSound('levelStart');
            saveProgress();
        }

        // ==================== LEVEL 1: NETWORK RECONNAISSANCE ====================
        
        let networkCanvas, networkCtx;
        let networkNodes = [];
        let networkScanProgress = 0;
        let threatsFound = 0;
        const TOTAL_THREATS = 2;
        let networkAnimationFrame = null;

        function loadNetworkLevel(container) {
            // Get attacker from another analyst
            // ‚úÖ DEBUG: Check IP values
    console.log('üåê Loading Level 1 Network...');
    console.log('SYSTEM_IP:', SYSTEM_IP);
    console.log('gameState.systemIP:', gameState.systemIP);
        const attackerInfo = getAttackerForAnalyst();
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: var(--color-text-secondary);">‚ö° Click nodes to scan for threats</p>
                </div>
                <canvas class="network-canvas" id="networkCanvas" width="1200" height="600"></canvas>
                <div class="network-controls">
                    <div class="control-btn" onclick="startNetworkScan()">üîç START DEEP SCAN</div>
                    <div class="control-btn" id="scanStatus">READY</div>
                </div>
            `;

            networkCanvas = document.getElementById('networkCanvas');
            networkCtx = networkCanvas.getContext('2d');

          

networkNodes = [
    { x: 150, y: 300, label: 'INTERNET', ip: '0.0.0.0', icon: 'üåê', threat: false, scanned: false, size: 60 },
    { x: 350, y: 300, label: 'FIREWALL', ip: '192.168.1.1', icon: 'üõ°Ô∏è', threat: false, scanned: false, size: 50 },
    { x: 600, y: 180, label: 'AUTH SERVER', ip: '192.168.1.10', icon: 'üîê', threat: false, scanned: false, size: 50 },
    { x: 600, y: 420, label: 'FILE SERVER', ip: '192.168.1.20', icon: 'üíæ', threat: false, scanned: false, size: 50 },
    { 
        x: 850, y: 220, 
        label: gameState.player ? gameState.player.toUpperCase() : 'USER PC #1', 
        ip: SYSTEM_IP,
        icon: 'üíª', 
        threat: true, 
        scanned: false, 
        size: 50,
        info: 'COMPROMISED - Active connection to attacker',
        details: {
            ports: ['22 (SSH) - OPEN', '3389 (RDP) - OPEN', '445 (SMB) - VULNERABLE'],
            traffic: `Outbound 2.4 GB to ${attackerInfo.ip}`,
            vulnerability: 'CVE-2024-XXXX: Brute Force Successful',
            severity: 'CRITICAL',
            resolution: 'ISOLATE MACHINE FROM NETWORK IMMEDIATELY',
            user: gameState.player || 'unknown'
        }
    },
    { x: 850, y: 380, label: 'USER PC #2', ip: '192.168.1.46', icon: 'üíª', threat: false, scanned: false, size: 45 },
   {
                x: 1100, y: 300,
                label: `ATTACKER: ${attackerInfo.player}`,
                ip: attackerInfo.ip,
                icon: '‚ò†Ô∏è',
                threat: true,
                scanned: false,
                size: 55,
                info: `THREAT SOURCE - ${attackerInfo.location}`,
                details: {
                    location: attackerInfo.location,
                    team: attackerInfo.team,
                    player: attackerInfo.player,
                    reputation: 'COMPROMISED ANALYST SYSTEM',
                    activity: 'Data Exfiltration in Progress',
                    severity: 'CRITICAL',
                    resolution: 'ISOLATE AND BLOCK IMMEDIATELY',
                    sourceIP: attackerInfo.ip
                }
            }
];

            networkCanvas.addEventListener('click', handleNetworkClick);
            animateNetwork();
        }

        function animateNetwork() {
            if (!networkCanvas) return;

            networkCtx.clearRect(0, 0, networkCanvas.width, networkCanvas.height);

            // Draw connections
            networkCtx.strokeStyle = 'rgba(0, 212, 255, 0.2)';
            networkCtx.lineWidth = 2;
            
            const connections = [
                [0, 1], [1, 2], [1, 3], [2, 4], [2, 5], [4, 6]
            ];

            connections.forEach(([from, to]) => {
                const nodeFrom = networkNodes[from];
                const nodeTo = networkNodes[to];
                
                networkCtx.beginPath();
                networkCtx.moveTo(nodeFrom.x, nodeFrom.y);
                networkCtx.lineTo(nodeTo.x, nodeTo.y);
                networkCtx.stroke();
            });

            // Draw nodes
            networkNodes.forEach((node, index) => {
                // Node circle
                networkCtx.beginPath();
                networkCtx.arc(node.x, node.y, node.size, 0, Math.PI * 2);
                
                if (node.scanned) {
                    networkCtx.fillStyle = node.threat ? 'rgba(255, 68, 68, 0.3)' : 'rgba(0, 255, 136, 0.3)';
                    networkCtx.strokeStyle = node.threat ? '#ff4444' : '#00ff88';
                } else {
                    networkCtx.fillStyle = 'rgba(0, 212, 255, 0.1)';
                    networkCtx.strokeStyle = 'rgba(0, 212, 255, 0.5)';
                }
                
                networkCtx.lineWidth = 3;
                networkCtx.fill();
                networkCtx.stroke();

                // Icon
                networkCtx.font = '32px Arial';
                networkCtx.textAlign = 'center';
                networkCtx.textBaseline = 'middle';
                networkCtx.fillStyle = '#fff';
                networkCtx.fillText(node.icon, node.x, node.y);

                // Label
                networkCtx.font = 'bold 11px "JetBrains Mono", monospace';
                networkCtx.fillStyle = '#fff';
                networkCtx.fillText(node.label, node.x, node.y + node.size + 18);

                // IP Address - ALWAYS VISIBLE
                networkCtx.font = '10px "JetBrains Mono", monospace';
                networkCtx.fillStyle = node.threat ? '#ff4444' : '#00d4ff';
                networkCtx.fillText(node.ip, node.x, node.y + node.size + 32);

                // Threat indicator
                if (node.scanned && node.threat) {
                    networkCtx.fillStyle = '#ff4444';
                    networkCtx.font = 'bold 10px Arial';
                    networkCtx.fillText('‚ö†Ô∏è THREAT DETECTED', node.x, node.y + node.size + 48);
                }
            });

            networkAnimationFrame = requestAnimationFrame(animateNetwork);
        }

        function handleNetworkClick(event) {
            const rect = networkCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            networkNodes.forEach(node => {
                const distance = Math.sqrt((x - node.x) ** 2 + (y - node.y) ** 2);
                
                if (distance < node.size && !node.scanned) {
                    scanNode(node);
                }
            });
        }

        function scanNode(node) {
            // THREAT-FIRST RULE: Must scan all threats before clean nodes
            if (!node.threat && threatsFound < TOTAL_THREATS) {
                reduceHealth('wrongNode');
                showNotification(`‚ö†Ô∏è SCAN THREATS FIRST! You must identify all ${TOTAL_THREATS} threats before scanning clean nodes. (Found: ${threatsFound}/${TOTAL_THREATS})`, 'error');
                playSound('alert');
               // recordWrongClick();
                return;
            }
            
            if (node.scanned) {
                showNotification('Already scanned', 'warning');
                return;
            }
            
            node.scanned = true;
            networkScanProgress++;

            // Show scanning process
            showNotification(`üîç Scanning ${node.label} (${node.ip})...`, 'info');

            if (node.threat) {
                threatsFound++;
                gameState.evidence.push(`Threat #${threatsFound}: ${node.label} (${node.ip})`);
                addScore(50); // Bonus for finding threats
                
                // Show detailed threat info
                setTimeout(() => {
                    showNotification(`‚ö†Ô∏è THREAT ${threatsFound}/${TOTAL_THREATS} DETECTED: ${node.label}`, 'error');
                    playSound('threat');
                    
                    if (node.details) {
                        setTimeout(() => {
                            let detailMsg = `üìä THREAT ANALYSIS:\n`;
                            if (node.details.ports) detailMsg += `Ports: ${node.details.ports.join(', ')}\n`;
                            if (node.details.vulnerability) detailMsg += `Vulnerability: ${node.details.vulnerability}\n`;
                            if (node.details.traffic) detailMsg += `Traffic: ${node.details.traffic}\n`;
                            if (node.details.severity) detailMsg += `Severity: ${node.details.severity}\n`;
                            if (node.details.resolution) detailMsg += `\n‚úì RECOMMENDED: ${node.details.resolution}`;
                            
                            alert(detailMsg);
                        }, 800);
                    }
                    
                    if (threatsFound === TOTAL_THREATS) {
                        showNotification('‚úÖ All threats identified! You can now scan other nodes.', 'success');
                    }
                }, 500);
            } else {
                addScore(20);
                showNotification(`‚úì Scanned: ${node.label} (${node.ip}) - Clean`, 'success');
                playSound('scan');
            }

            // Check completion
            if (networkScanProgress >= networkNodes.length) {
                document.getElementById('completeBtn').disabled = false;
                showNotification('üéØ All nodes scanned! Network analysis complete.', 'success');
                unlockAchievement('network_complete');
            }

            saveProgress();
        }

        function startNetworkScan() {
            showNotification('üîç Deep scan initiated...', 'info');
            document.getElementById('scanStatus').textContent = 'SCANNING...';
            
            const steps = [
                'Initializing network topology scan...',
                'Analyzing port configurations...',
                'Detecting vulnerabilities...',
                'Analyzing traffic patterns...',
                'Identifying threats...'
            ];
            
            let step = 0;
            const interval = setInterval(() => {
                if (step < steps.length) {
                    showNotification(steps[step], 'info');
                    step++;
                } else {
                    clearInterval(interval);
                    showNotification('üìä Deep scan complete. Click nodes to view detailed analysis.', 'success');
                    document.getElementById('scanStatus').textContent = 'SCAN COMPLETE';
                }
            }, 1000);
            } 2000;
        

        // ==================== LEVEL 2: LOG FORENSICS ====================
        
        let logData = [];
        let selectedLogs = [];
        let criticalLogsSelected = 0;
        let warnLogsSelected = 0;
        let timelineEvents = [];

        function loadLogsLevel(container) {
            // Get attacker info for dynamic logs
        const attackerInfo = getAttackerForAnalyst();
            container.innerHTML = `
                <div class="siem-container">
                    <div class="glass-panel">
                        <h3 style="font-family: var(--font-display); font-size: 14px; color: var(--color-accent-cyan); margin-bottom: 15px; text-transform: uppercase;">LIVE LOG FEED</h3>
                        <div class="log-viewer" id="logViewer"></div>
                    </div>
                    <div class="glass-panel timeline-builder">
                        <h3>ATTACK TIMELINE</h3>
                        <p style="font-size: 11px; color: var(--color-text-secondary); margin-bottom: 15px;">Click suspicious logs to build timeline</p>
                        <div class="timeline-events" id="timelineEvents"></div>
                    </div>
                </div>
            `;

            logData = [
                // PHASE 1: RECONNAISSANCE (Scanning Phase) - 12 logs
                { time: '14:15:03', level: 'info', text: '[SYSTEM] Firewall rules updated successfully' },
                { time: '14:15:45', level: 'info', text: '[AUTH] System maintenance scheduled for 02:00 AM' },
                { time: '14:16:12', level: 'warn', text: '[NETWORK] Port scan detected from ', suspicious: true },
                { time: '14:16:45', level: 'warn', text: '[FIREWALL] Multiple connection attempts from foreign IP', suspicious: true },
                { time: '14:17:03', level: 'info', text: '[SYSTEM] Backup process initiated' },
                { time: '14:17:21', level: 'warn', text: '[NETWORK] Unusual traffic pattern detected on port 22', suspicious: true },
                { time: '14:18:05', level: 'info', text: '[AUTH] User login: admin@192.168.1.10' },
                { time: '14:18:34', level: 'warn', text: '[NETWORK] Reconnaissance activity from (Lagos, Nigeria)', suspicious: true },
                { time: '14:18:56', level: 'info', text: '[SYSTEM] Database query executed successfully' },
                { time: '14:19:12', level: 'info', text: '[FILE] Document access: /documents/public/readme.txt' },
                { time: '14:19:28', level: 'warn', text: '[FIREWALL] Port 3389 (RDP) probe detected', suspicious: true },
                { time: '14:19:45', level: 'info', text: '[SYSTEM] Memory usage: 45% - Normal' },

                // PHASE 2: INITIAL ACCESS (Brute Force Attack) - 15 logs
                { time: '14:20:01', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
                { time: '14:20:03', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
               { time: '14:20:05', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
               { time: '14:20:07', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
               { time: '14:20:09', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
                { time: '14:20:15', level: 'critical', text: '[AUTH] BRUTE FORCE ATTACK DETECTED - 50+ attempts in 60 seconds', suspicious: true },
                { time: '14:20:23', level: 'info', text: '[SYSTEM] Routine checkpoint saved' },
                { time: '14:20:34', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
               { time: '14:20:36', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
                { time: '14:20:38', level: 'warn', text: `AUTH: Failed login ${gameState.player || 'user'} from ${attackerInfo.ip}`, suspicious: true },
                { time: '14:20:56', level: 'critical', text: `AUTH: Account compromised ${gameState.player || 'user'}@192.168.1.45`, suspicious: true },
               { time: '14:21:03', level: 'critical', text: `AUTH: Successful login ${gameState.player || 'user'} from ${attackerInfo.ip} (${attackerInfo.location})`, suspicious: true },
               { time: '14:21:12', level: 'info', text: `SYSTEM: User session established (${gameState.player || 'user'})` },
                { time: '14:21:28', level: 'warn', text: '[SECURITY] Unusual login location detected', suspicious: true },
                { time: '14:21:45', level: 'info', text: '[NETWORK] Session timeout extended' },

                // PHASE 3: PERSISTENCE (Backdoor Installation) - 13 logs
                { time: '14:22:03', level: 'warn', text: '[SYSTEM] Unauthorized process spawned on 192.168.1.45', suspicious: true },
                { time: '14:22:21', level: 'critical', text: '[SECURITY] Backdoor detected: /tmp/.hidden_service', suspicious: true },
                { time: '14:22:38', level: 'warn', text: `FIREWALL: Outbound connection to ${attackerInfo.ip}:4444`, suspicious: true },
                { time: '14:22:45', level: 'info', text: '[SYSTEM] Memory usage: 78%' },
                { time: '14:23:01', level: 'critical', text: '[SECURITY] Persistence mechanism installed on 192.168.1.45', suspicious: true },
                { time: '14:23:18', level: 'warn', text: '[SYSTEM] Registry modification detected', suspicious: true },
                { time: '14:23:34', level: 'info', text: '[AUTH] Token refresh completed' },
                { time: '14:23:56', level: 'warn', text: `NETWORK: Encrypted tunnel established to ${attackerInfo.ip}`, suspicious: true },
                { time: '14:24:12', level: 'critical', text: '[SECURITY] Command & Control server connection active', suspicious: true },
                { time: '14:24:28', level: 'info', text: '[SYSTEM] Scheduled task created' },
                { time: '14:24:45', level: 'warn', text: '[FIREWALL] Persistent outbound connection detected', suspicious: true },
                { time: '14:25:03', level: 'info', text: '[FILE] File access logged: system logs' },
                { time: '14:25:21', level: 'critical', text: '[SECURITY] Lateral movement attempt detected', suspicious: true },

                // PHASE 4: DATA EXFILTRATION - 10 logs
                { time: '14:25:38', level: 'warn', text: '[FILE] Bulk file access on 192.168.1.45', suspicious: true },
                { time: '14:25:56', level: 'critical', text: `NETWORK: Large outbound transfer (245 MB) to ${attackerInfo.ip}`, suspicious: true },
                { time: '14:26:12', level: 'critical', text: '[SECURITY] DATA EXFILTRATION IN PROGRESS', suspicious: true },
                { time: '14:26:28', level: 'warn', text: '[FILE] Sensitive documents accessed: /documents/confidential/', suspicious: true },
                { time: '14:26:45', level: 'critical', text: '[NETWORK] Outbound traffic spike: 2.4 GB transferred', suspicious: true },
                { time: '14:27:01', level: 'info', text: '[SYSTEM] CPU usage: 92%' },
                { time: '14:27:18', level: 'critical', text: '[FILE] Database dump initiated: customers.db', suspicious: true },
                { time: '14:27:34', level: 'critical', text: '[SECURITY] Customer data breach detected - 50,000+ records', suspicious: true },
                { time: '14:27:52', level: 'critical', text: '[ALERT] Active data theft - IMMEDIATE ACTION REQUIRED', suspicious: true },
                { time: '14:28:15', level: 'critical', text: '[SECURITY] Total data exfiltrated: 5.8 GB', suspicious: true }
            ];

            streamLogs();
        }

        function streamLogs() {
            const viewer = document.getElementById('logViewer');
            let index = 0;

            const interval = setInterval(() => {
                if (index >= logData.length) {
                    clearInterval(interval);
                    return;
                }

                const log = logData[index];
                const logLine = document.createElement('div');
                logLine.className = `log-line ${log.level}`;
                logLine.textContent = `[${log.time}] ${log.text}`;
                
                if (log.suspicious) {
                    logLine.style.cursor = 'pointer';
                    logLine.onclick = function() {
                        if (!this.classList.contains('selected')) {
                            selectLog(log, this);
                        }
                    };
                }

                viewer.appendChild(logLine);
                viewer.scrollTop = viewer.scrollHeight;
                index++;
            }, 400);
        }

        function selectLog(log, element) {
            if (!log.suspicious) {
                reduceHealth('wrongLog');
                recordWrongClick();
                // gameState.mistakes++; // ‚úÖ ADD THIS
        //updateHUD(); // ‚úÖ ADD THIS
                showNotification('‚ö†Ô∏è Not suspicious! Click only [WARN] and [CRITICAL] entries.', 'error');
                return;
            }
            
            if (element.classList.contains('selected')) {
                showNotification('Already selected', 'warning');
                return;
            }
            
            // Count total critical and warn logs
            const totalCritical = logData.filter(l => l.suspicious && l.level === 'critical').length;
            const totalWarn = logData.filter(l => l.suspicious && l.level === 'warn').length;
            
            // SEVERITY RULE: Must click ALL CRITICAL before ANY WARN
            if (log.level === 'warn' && criticalLogsSelected < totalCritical) {
                reduceHealth('wrongLog');
                 //gameState.mistakes++; // ‚úÖ ADD THIS
       // updateHUD(); // ‚úÖ ADD THIS
                showNotification(`‚ö†Ô∏è Click ALL ${totalCritical} CRITICAL logs first! (Currently: ${criticalLogsSelected}/${totalCritical})`, 'error');
                playSound('alert');
                return;
            }
            
            element.classList.add('selected');
            selectedLogs.push(log);
            
            if (log.level === 'critical') {
                criticalLogsSelected++;
                addScore(25);
                if (criticalLogsSelected === totalCritical) {
                    showNotification(`‚úÖ All CRITICAL logs found! Now click ${totalWarn} WARN logs.`, 'success');
                }
            } else if (log.level === 'warn') {
                warnLogsSelected++;
                addScore(15);
            }
            
            const timeline = document.getElementById('timelineEvents');
            const event = document.createElement('div');
            event.className = 'timeline-event';
            event.textContent = `[${log.time}] ${log.text}`;
            timeline.appendChild(event);

            gameState.evidence.push(`Log entry: ${log.text}`);
            playSound('success');

            const suspiciousCount = logData.filter(l => l.suspicious).length;
            if (selectedLogs.length >= suspiciousCount) {
                document.getElementById('completeBtn').disabled = false;
                showNotification('‚úì Attack timeline constructed successfully!', 'success');
                unlockAchievement('forensics_complete');
            }

            saveProgress();
        }

        // ==================== LEVEL 3: ATTACK VISUALIZATION (DRAWING) ====================
        
        let drawingCanvas, drawingCtx;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let drawingComplete = false;

        function loadDrawingLevel(container) {
            container.innerHTML = `
                <div class="drawing-container">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="font-size: 24px; color: var(--primary); margin-bottom: 15px;">üìä CREATE ATTACK DIAGRAM</h3>
                        <p style="color: #9ca3af; font-size: 16px; margin-bottom: 10px;">Draw the complete attack flow showing:</p>
                        <ul style="list-style: none; color: #9ca3af; font-size: 14px; line-height: 2;">
                            <li>üåê Internet ‚Üí üî• Firewall ‚Üí üîê Auth Server ‚Üí üíª User PC</li>
                            <li>‚ö†Ô∏è Attacker (103.21.58.12 - Nigeria)</li>
                            <li>‚û°Ô∏è Attack path with arrows</li>
                            <li>üìù Labels for each component</li>
                        </ul>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="tool-btn active" data-tool="pen" onclick="selectTool('pen')">‚úèÔ∏è Draw</button>
                        <button class="tool-btn" data-tool="text" onclick="selectTool('text')">üìù Text</button>
                        <button class="tool-btn" data-tool="eraser" onclick="selectTool('eraser')">üßπ Erase</button>
                        <input type="color" id="colorPicker" value="#000000" onchange="changeColor()" style="width: 50px; height: 40px; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer;">
                        <button class="tool-btn" onclick="clearCanvas()">üóëÔ∏è Clear All</button>
                        <button class="tool-btn" onclick="saveDrawing()" style="background: var(--primary); color: var(--dark);">üíæ Submit for Approval</button>
                    </div>

                    <div style="text-align: center; margin-bottom: 15px; color: var(--color-accent-cyan); font-size: 14px;">
                        <strong>Required Labels:</strong> Internet, Firewall, Auth Server, User PC #1, User PC #2, Attacker
                    </div>

                    <div style="display: flex; justify-content: center;">
                        <canvas id="drawingCanvas" width="800" height="600" 
                            style="background: white; border: 3px solid var(--primary); border-radius: 12px; cursor: crosshair; box-shadow: 0 10px 40px rgba(0, 255, 136, 0.3);"></canvas>
                    </div>

                    <div id="drawingStatus" style="text-align: center; margin-top: 20px; font-size: 16px; color: var(--primary);"></div>
                </div>
            `;

            drawingCanvas = document.getElementById('drawingCanvas');
            drawingCtx = drawingCanvas.getContext('2d');
            
            // Set up drawing
            drawingCtx.lineWidth = 3;
            drawingCtx.lineCap = 'round';
            drawingCtx.strokeStyle = currentColor;

            // Add event listeners
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);
            drawingCanvas.addEventListener('click', handleCanvasClick);

            // Touch support
            drawingCanvas.addEventListener('touchstart', handleTouch);
            drawingCanvas.addEventListener('touchmove', handleTouch);
            drawingCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            drawingCtx.beginPath();
            drawingCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentTool === 'pen') {
                drawingCtx.strokeStyle = currentColor;
                drawingCtx.lineWidth = 3;
                drawingCtx.lineTo(x, y);
                drawingCtx.stroke();
            } else if (currentTool === 'eraser') {
                drawingCtx.clearRect(x - 10, y - 10, 20, 20);
            }
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleCanvasClick(e) {
            if (currentTool !== 'text') return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const text = prompt('Enter label text (e.g., "Firewall", "Attacker"):');
            if (text && text.trim()) {
                drawingCtx.fillStyle = currentColor;
                drawingCtx.font = 'bold 18px Arial';
                drawingCtx.fillText(text.trim(), x, y);
                showNotification(`‚úì Label added: ${text}`, 'success');
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            drawingCanvas.dispatchEvent(mouseEvent);
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Get the clicked button and make it active
            const buttons = document.querySelectorAll('.tool-btn');
            buttons.forEach(btn => {
                if (btn.dataset.tool === tool || btn.textContent.includes(tool)) {
                    btn.classList.add('active');
                }
            });

            // Change cursor based on tool
            if (tool === 'text') {
                drawingCanvas.style.cursor = 'text';
            } else if (tool === 'eraser') {
                drawingCanvas.style.cursor = 'not-allowed';
            } else {
                drawingCanvas.style.cursor = 'crosshair';
            }
        }

        function changeColor() {
            currentColor = document.getElementById('colorPicker').value;
            drawingCtx.strokeStyle = currentColor; // Apply color to canvas context
        }

        function clearCanvas() {
            if (confirm('Clear the entire canvas?')) {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingComplete = false;
                document.getElementById('drawingStatus').textContent = '';
                document.getElementById('completeBtn').disabled = true;
            }
        }

        function isCanvasBlank() {
            const imageData = drawingCtx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height);
            const pixels = imageData.data;
            
            for (let i = 0; i < pixels.length; i += 4) {
                if (pixels[i + 3] !== 0) { // Check alpha channel
                    return false; // Found a non-transparent pixel
                }
            }
            return true; // Canvas is blank
        }

        function saveDrawing() {
            // Check if already submitted
            if (gameState.pendingApproval && !gameState.pendingApproval.rejected) {
                showNotification('‚ö†Ô∏è Drawing already submitted! Waiting for instructor approval...', 'warning');
                return;
            }
            
            if (isCanvasBlank()) {
                showNotification('‚ö†Ô∏è Please draw something before submitting!', 'error');
                return;
            }
            
            // Track attempts
            gameState.drawingAttempts = (gameState.drawingAttempts || 0) + 1;
            
            // Save the drawing as base64
            const drawingData = drawingCanvas.toDataURL('image/png');
            
            gameState.evidence.push(`Diagram submitted - Attempt #${gameState.drawingAttempts}`);
            gameState.pendingApproval = {
                team: gameState.team,
                player: gameState.player,
                drawing: drawingData,
                timestamp: Date.now(),
                attempt: gameState.drawingAttempts,
                rejected: false
            };
            
            drawingComplete = true;
            
            // Disable submit button
            const submitBtn = document.querySelector('button[onclick="saveDrawing()"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.textContent = '‚úì SUBMITTED - AWAITING APPROVAL';
            }
            
            document.getElementById('drawingStatus').innerHTML = `
                <div style="padding: 25px; background: rgba(255, 170, 0, 0.2); border: 2px solid var(--warning); border-radius: 12px; max-width: 700px; margin: 20px auto;">
                    <h3 style="color: var(--warning); font-size: 20px; margin-bottom: 15px;">‚è≥ AWAITING INSTRUCTOR APPROVAL</h3>
                    <p style="color: #9ca3af; font-size: 16px; line-height: 1.8;">
                        Attempt #${gameState.drawingAttempts}<br>
                        Submitted: ${new Date().toLocaleTimeString()}<br><br>
                        The instructor will review your diagram shortly.<br>
                        <strong>Level 4 will unlock after approval.</strong>
                    </p>
                    <p style="color: var(--color-accent-cyan); font-size: 13px; margin-top: 10px; animation: pulse 2s infinite;">
                        üîÑ Checking for approval... (auto-refresh every 3 seconds)
                    </p>
                </div>
            `;

    
    // Save so instructor can approve
    playSound('success');
    saveProgress();
    showNotification('Drawing submitted! Waiting for instructor approval...', 'success');
    
    // Start checking for approval
    startApprovalPolling();
}


        // ==================== LEVEL 4: THREAT INTELLIGENCE ====================
        
        // ==================== LEVEL 4: THREAT INTELLIGENCE (OSINT) ====================
let osintCompleted = { ipLookup: false, geoLocation: false, threatDB: false, userID: false, deviceType: false };

function loadOSINTLevel(container) {

        
const attackerInfo = getAttackerForAnalyst();
    // Shuffle function for random option order
    function shuffleArray(array) {
 // Get attacker info

        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }
    
    // Generate IP options with correct answer using SYSTEM_IP
    const ipOptions = shuffleArray([
        attackerInfo.ip,
        '192.168.1.42',
        '192.168.1.43',
        '192.168.1.44',
        '192.168.1.47'
    ]);
    
    // Generate user options with correct answer using gameState.player
    const userOptions = shuffleArray([
        gameState.player || 'player',
        'john.doe',
        'admin.user',
        'test.account',
        'guest.user'
    ]);
    
    container.innerHTML = `
        <div style="background: rgba(255, 68, 68, 0.1); padding: 20px; border-left: 4px solid var(--color-danger); border-radius: 8px; margin-bottom: 30px;">
            <h3 style="color: var(--color-warning); margin-bottom: 10px;">‚ö†Ô∏è WARNING: DECOY DATA DETECTED</h3>
            <p style="color: var(--color-text-secondary); font-size: 14px;">
                Multiple fake databases and incorrect information have been planted. Choose carefully!<br>
                <strong>Wrong choices will reduce your health and score.</strong>
            </p>
        </div>

        <div class="osint-grid">
            <!-- 1. IP GEOLOCATION -->
            <div class="glass-panel osint-panel">
                <h3>üåç IP GEOLOCATION</h3>
                <p style="color: var(--color-text-secondary); font-size: 13px; margin: 10px 0;">
                    Select the CORRECT compromised system IP to lookup
                </p>
                ${ipOptions.map(ip => `
                    <button class="lookup-btn" onclick="lookupIP('${ip}')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                        ${ip}
                    </button>
                `).join('')}
                <div id="geoResult" style="margin-top: 15px;"></div>
            </div>

            <!-- 2. THREAT DATABASE -->
            <div class="glass-panel osint-panel">
                <h3>üõ°Ô∏è THREAT DATABASE</h3>
                <p style="color: var(--color-text-secondary); font-size: 13px; margin: 10px 0;">
                    Select the REAL threat intelligence database
                </p>
                <button class="lookup-btn" onclick="lookupThreatDB('VirusScan')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    VirusScan
                </button>
                <button class="lookup-btn" onclick="lookupThreatDB('VirusTotal')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    VirusTotal
                </button>
                <button class="lookup-btn" onclick="lookupThreatDB('ThreatCheck')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    ThreatCheck
                </button>
                <div id="threatResult" style="margin-top: 15px;"></div>
            </div>

            <!-- 3. COMPROMISED USER -->
            <div class="glass-panel osint-panel">
                <h3>üë§ COMPROMISED USER</h3>
                <p style="color: var(--color-text-secondary); font-size: 13px; margin: 10px 0;">
                    Identify the compromised account from logs
                </p>
                ${userOptions.map(user => `
                    <button class="lookup-btn" onclick="identifyUser('${user}')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                        ${user}
                    </button>
                `).join('')}
                <div id="userResult" style="margin-top: 15px;"></div>
            </div>

            <!-- 4. ATTACK VECTOR -->
            <div class="glass-panel osint-panel">
                <h3>‚öîÔ∏è ATTACK VECTOR</h3>
                <p style="color: var(--color-text-secondary); font-size: 13px; margin: 10px 0;">
                    Identify the primary attack method used
                </p>
                <button class="lookup-btn" onclick="identifyAttackVector('SQL Injection')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    SQL Injection
                </button>
                <button class="lookup-btn" onclick="identifyAttackVector('Brute Force')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    Brute Force
                </button>
                <button class="lookup-btn" onclick="identifyAttackVector('Phishing')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    Phishing
                </button>
                <button class="lookup-btn" onclick="identifyAttackVector('XSS')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    XSS
                </button>
                <button class="lookup-btn" onclick="identifyAttackVector('DDoS')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    DDoS
                </button>
                <div id="attackResult" style="margin-top: 15px;"></div>
            </div>

            <!-- 5. THREAT ORIGIN -->
            <div class="glass-panel osint-panel">
                <h3>üåê THREAT ORIGIN</h3>
                <p style="color: var(--color-text-secondary); font-size: 13px; margin: 10px 0;">
                    Identify the attacker's country of origin
                </p>
                <button class="lookup-btn" onclick="identifyOrigin('China')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    China
                </button>
                <button class="lookup-btn" onclick="identifyOrigin('Nigeria')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    Nigeria
                </button>
                <button class="lookup-btn" onclick="identifyOrigin('Russia')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    Russia
                </button>
                <button class="lookup-btn" onclick="identifyOrigin('USA')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    USA
                </button>
                <button class="lookup-btn" onclick="identifyOrigin('India')" style="margin: 5px; background: rgba(255,255,255,0.1);">
                    India
                </button>
                <div id="originResult" style="margin-top: 15px;"></div>
            </div>

            <!-- INTEL SUMMARY -->
            <div class="glass-panel osint-panel">
                <h3>üìä INTEL SUMMARY</h3>
                <div style="font-family: var(--font-mono); font-size: 14px; padding: 15px;">
                    <div style="color: var(--color-text-secondary); margin-bottom: 10px;">Correct Answers:</div>
                    <div id="osintScore" style="font-size: 28px; color: var(--color-accent-cyan); margin: 15px 0;">0 / 5</div>
                    <div style="font-size: 12px; color: var(--color-text-secondary);">Complete all 5 correctly to proceed</div>
                </div>
            </div>
        </div>
    `;

    // Reset OSINT tracking
    window.osintCorrect = 0;
    window.osintAttempts = { ip: false, db: false, user: false, attack: false, origin: false };
}

// 1. IP GEOLOCATION LOOKUP
function lookupIP(ip) {
        if (window.osintAttempts.ip) {
            showNotification('Already completed', 'info');
            return;
        }
        
        const result = document.getElementById('geoResult');
        const attackerInfo = getAttackerForAnalyst();  // ADD THIS
        
        if (ip === attackerInfo.ip) {  // CHANGED FROM SYSTEM_IP
        // CORRECT
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--color-accent-green); border-radius: 6px;">
                <div style="color: var(--color-accent-green); font-weight: bold; margin-bottom: 8px;">‚úì CORRECT IP</div>
                <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.8; color: var(--color-text-secondary);">
                    Attacker IP: ${attackerInfo.ip}<br>
                        Team: ${attackerInfo.team}<br>
                        Player: ${attackerInfo.player}<br>
                        Location: ${attackerInfo.location}<br>
                        Status: ACTIVE THREAT
                    
                </div>
            </div>
        `;
        window.osintCorrect++;
        window.osintAttempts.ip = true;
        addScore(20);
        gameState.evidence.push(`Verified compromised IP: ${SYSTEM_IP}`);
        playSound('success');
        updateOSINTScore();
    } else {
        // WRONG - TRAP
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid var(--color-danger); border-radius: 6px;">
                <div style="color: var(--color-danger); font-weight: bold;">‚úó WRONG IP - DECOY!</div>
                <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 5px;">
                    This is a fake IP planted as a distraction.
                </div>
            </div>
        `;
        reduceHealth('wrongNode');
        gameState.score = Math.max(0, gameState.score - 10);
       // gameState.mistakes++; // ‚úÖ ADD THIS
        updateHUD();
        showNotification('Wrong IP! That\'s a decoy. Check the network scan from Level 1.', 'error');
        playSound('alert');
    }
}

// 2. THREAT DATABASE LOOKUP
function lookupThreatDB(database) {
    if (window.osintAttempts.db) {
        showNotification('Already completed', 'info');
        return;
    }

    const result = document.getElementById('threatResult');
    
    if (database === 'VirusTotal') {
        // CORRECT
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--color-accent-green); border-radius: 6px;">
                <div style="color: var(--color-accent-green); font-weight: bold; margin-bottom: 8px;">‚úì LEGITIMATE DATABASE</div>
                <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.8; color: var(--color-text-secondary);">
                    IP Flagged: Known malicious actor<br>
                    Reports: 47 security vendors flagged<br>
                    Last seen: Active in last 24 hours
                </div>
            </div>
        `;
        window.osintCorrect++;
        window.osintAttempts.db = true;
        addScore(20);
        gameState.evidence.push('VirusTotal: IP confirmed malicious');
        playSound('success');
        updateOSINTScore();
    } else {
        // WRONG - FAKE DATABASE
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid var(--color-danger); border-radius: 6px;">
                <div style="color: var(--color-danger); font-weight: bold;">‚úó FAKE DATABASE!</div>
                <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 5px;">
                    This is not a real threat intelligence database.
                </div>
            </div>
        `;
        reduceHealth('wrongNode');
        gameState.score = Math.max(0, gameState.score - 10);
        updateHUD();
        //gameState.mistakes++; // ‚úÖ ADD THIS
        showNotification(`${database} is a fake database! Use legitimate threat intelligence sources.`, 'error');
        playSound('alert');
    }
}

// 3. COMPROMISED USER
function identifyUser(username) {
    if (window.osintAttempts.user) {
        showNotification('Already completed', 'info');
        return;
    }

    const result = document.getElementById('userResult');
    const correctUser = gameState.player || 'player';
    
    if (username === correctUser) {
        // CORRECT
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--color-accent-green); border-radius: 6px;">
                <div style="color: var(--color-accent-green); font-weight: bold; margin-bottom: 8px;">‚úì CORRECT USER</div>
                <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.8; color: var(--color-text-secondary);">
                    Account: ${username}<br>
                    Status: COMPROMISED<br>
                    Failed logins: 50+ attempts<br>
                    Access: UNAUTHORIZED
                </div>
            </div>
        `;
        window.osintCorrect++;
        window.osintAttempts.user = true;
        addScore(20);
        gameState.evidence.push(`Identified compromised account: ${username}`);
        playSound('success');
        updateOSINTScore();
    } else {
        // WRONG USER
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid var(--color-danger); border-radius: 6px;">
                <div style="color: var(--color-danger); font-weight: bold;">‚úó WRONG USER!</div>
                <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 5px;">
                    This account was not compromised. Check the logs from Level 2.
                </div>
            </div>
        `;
        reduceHealth('wrongNode');
        gameState.score = Math.max(0, gameState.score - 10);
        //gameState.mistakes++; // ‚úÖ ADD THIS
        updateHUD();
        showNotification('Wrong user! Review the logs to find the compromised account.', 'error');
        playSound('alert');
    }
}

// 4. ATTACK VECTOR
function identifyAttackVector(vector) {
    if (window.osintAttempts.attack) {
        showNotification('Already completed', 'info');
        return;
    }

    const result = document.getElementById('attackResult');
    
    if (vector === 'Brute Force') {
        // CORRECT
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--color-accent-green); border-radius: 6px;">
                <div style="color: var(--color-accent-green); font-weight: bold; margin-bottom: 8px;">‚úì CORRECT ATTACK VECTOR</div>
                <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.8; color: var(--color-text-secondary);">
                    Method: Brute Force Attack<br>
                    Attempts: 50+ login attempts<br>
                    Target: SSH/RDP services<br>
                    Result: Successful compromise
                </div>
            </div>
        `;
        window.osintCorrect++;
        window.osintAttempts.attack = true;
        addScore(20);
        gameState.evidence.push('Attack vector identified: Brute Force');
        playSound('success');
        updateOSINTScore();
    } else {
        // WRONG VECTOR
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid var(--color-danger); border-radius: 6px;">
                <div style="color: var(--color-danger); font-weight: bold;">‚úó WRONG ATTACK VECTOR!</div>
                <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 5px;">
                    Review the logs to identify the correct attack method.
                </div>
            </div>
        `;
        reduceHealth('wrongNode');
        gameState.score = Math.max(0, gameState.score - 10);
        //  gameState.mistakes++; // ‚úÖ ADD THIS
        updateHUD();
        showNotification('Wrong attack vector! Check the authentication logs.', 'error');
        playSound('alert');
    }
}

// 5. THREAT ORIGIN
function identifyOrigin(country) {
    if (window.osintAttempts.origin) {
        showNotification('Already completed', 'info');
        return;
    }

    const result = document.getElementById('originResult');
    
    if (country === 'Nigeria') {
        // CORRECT
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(0, 255, 136, 0.1); border: 1px solid var(--color-accent-green); border-radius: 6px;">
                <div style="color: var(--color-accent-green); font-weight: bold; margin-bottom: 8px;">‚úì CORRECT ORIGIN</div>
                <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.8; color: var(--color-text-secondary);">
                    Location: Lagos, Nigeria<br>
                    Coordinates: 6.5244¬∞N, 3.3792¬∞E<br>
                    IP: 103.21.58.12<br>
                    Threat Level: HIGH
                </div>
            </div>
        `;
        window.osintCorrect++;
        window.osintAttempts.origin = true;
        addScore(20);
        gameState.evidence.push('Threat origin: Lagos, Nigeria');
        playSound('success');
        updateOSINTScore();
    } else {
        // WRONG COUNTRY
        result.innerHTML = `
            <div style="padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid var(--color-danger); border-radius: 6px;">
                <div style="color: var(--color-danger); font-weight: bold;">‚úó WRONG COUNTRY!</div>
                <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 5px;">
                    Check the geolocation data from the attacker IP.
                </div>
            </div>
        `;
        reduceHealth('wrongNode');
        gameState.score = Math.max(0, gameState.score - 10);
       // gameState.mistakes++; // ‚úÖ ADD THIS
        updateHUD();
        showNotification('Wrong country! Review the IP geolocation data.', 'error');
        playSound('alert');
    }
}

// UPDATE OSINT SCORE
function updateOSINTScore() {
    document.getElementById('osintScore').textContent = `${window.osintCorrect} / 5`;
    
    if (window.osintCorrect === 5) {
        document.getElementById('completeBtn').disabled = false;
        showNotification('All intelligence gathered correctly! Level complete.', 'success');
        unlockAchievement('osintcomplete');
    }
}

                
        function lookupThreat() {
            const btn = event.target;
            const result = document.getElementById('threatResult');
            
            btn.textContent = 'SEARCHING...';
            btn.disabled = true;

            setTimeout(() => {
                result.innerHTML = `
                    <div style="font-family: var(--font-mono); font-size: 12px; line-height: 1.8;">
                        <div style="color: var(--color-danger);">üö® KNOWN THREAT ACTOR</div>
                        <div style="color: var(--color-text-secondary);">First Seen: 2024-11-03</div>
                        <div style="color: var(--color-text-secondary);">Associated: Brute Force Attacks</div>
                        <div style="color: var(--color-danger);">Threat Level: HIGH</div>
                    </div>
                `;
                btn.classList.add('completed');
                btn.textContent = '‚úì COMPLETED';
                osintCompleted.threatDB = true;
                gameState.evidence.push('Threat DB: Known threat actor');
                addScore(25);
                checkOSINTCompletion();
            }, 1500);
        }

        function collectIOC() {
            const btn = event.target;
            const result = document.getElementById('iocResult');
            const countEl = document.getElementById('iocCount');
            
            btn.textContent = 'COLLECTING...';
            btn.disabled = true;

            setTimeout(() => {
    const attackerInfo = getAttackerForAnalyst(); // ‚úÖ GET DYNAMIC ATTACKER
    const iocs = [
        attackerInfo.ip,
        gameState.player || 'unknown',
        'SHA256: a8f5f167...',
        'Port 22 (SSH)'
    ];


                result.innerHTML = `
                    <div style="font-family: var(--font-mono); font-size: 11px; line-height: 1.8;">
                        ${iocs.map(ioc => `<div style="color: var(--color-accent-cyan);">‚Ä¢ ${ioc}</div>`).join('')}
                    </div>
                `;
                
                countEl.textContent = '4/4';
                btn.classList.add('completed');
                btn.textContent = '‚úì COMPLETED';
                osintCompleted.iocCollection = true;
                gameState.evidence.push('IOCs: 4 indicators collected');
                addScore(25);
                checkOSINTCompletion();
            }, 1500);
        }

        function checkOSINTCompletion() {
            if (Object.values(osintCompleted).every(v => v === true)) {
                document.getElementById('completeBtn').disabled = false;
                showNotification('‚úì Threat intelligence gathering complete!', 'success');
                unlockAchievement('osint_complete');
            }
        }

        // ==================== LEVEL 4: INCIDENT RESPONSE ====================
        
        let terminalCommands = {
            blocked: false,
            locked: false,
            mfaEnabled: false
        };

        function loadTerminalLevel(container) {
             const attackerInfo = getAttackerForAnalyst(); // ‚úÖ GET DYNAMIC DATA
            container.innerHTML = `
                <div class="terminal-container">
                    <div class="terminal-header">
                        <div class="terminal-title">üñ•Ô∏è SECURITY OPERATIONS TERMINAL</div>
                        <div class="threat-indicators">
                            <div class="threat-badge">3 ACTIVE THREATS</div>
                        </div>
                    </div>

                    <div class="terminal-output" id="terminalOutput">
                        <div class="terminal-line" style="color: var(--color-accent-cyan);">‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó</div>
                        <div class="terminal-line" style="color: var(--color-accent-cyan);">‚ïë  CYBERQUEST SECURITY OPERATIONS TERMINAL v3.2.1              ‚ïë</div>
                        <div class="terminal-line" style="color: var(--color-accent-cyan);">‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</div>
                        <div class="terminal-line" style="margin-top: 10px;">Type 'help' for available commands</div>
                        <div class="terminal-line" style="margin-top: 10px; color: var(--color-warning);">‚ö†Ô∏è CRITICAL: Neutralize all threats to proceed</div>
                        <div class="terminal-line" style="color: var(--color-warning);">1. Block attacker IP <span id="bossAttackerIP">Loading...</span></div>
                    <div class="terminal-line" style="color: var(--color-warning);">2. Lock compromised account <span id="bossPlayerName">Loading...</span></div>
                        <div class="terminal-line" style="color: var(--color-warning);">   3. Enable MFA on critical accounts</div>
                        <div class="terminal-line" style="margin-top: 10px;"></div>
                    </div>

                    <div class="terminal-input-area">
                        <div class="terminal-prompt">analyst@soc:~$</div>
                        <input type="text" class="terminal-input" id="terminalInput" placeholder="Enter command..." autocomplete="off" onkeydown="if(event.key==='Enter') handleTerminalCommand()">
                    </div>
                </div>
            `;

            document.getElementById('terminalInput').focus();
        }

        function handleTerminalCommand() {
            const input = document.getElementById('terminalInput');
            const output = document.getElementById('terminalOutput');
            const cmd = input.value.trim();
const attackerInfo = getAttackerForAnalyst();
            // Echo command
            const cmdLine = document.createElement('div');
            cmdLine.className = 'terminal-line';
            cmdLine.style.color = 'var(--color-text-primary)';
            cmdLine.textContent = `analyst@soc:~$ ${cmd}`;
            output.appendChild(cmdLine);

            // Process command
            let response = '';
            let success = false;

            if (cmd === '') {
                // Do nothing
            } else if (cmd === 'help') {
    const attackerInfo = getAttackerForAnalyst(); // ‚úÖ GET DYNAMIC DATA
    response = `
        <div style="color: var(--color-accent-cyan); margin-top: 10px;">AVAILABLE COMMANDS:</div>
        <div style="margin-left: 20px;">
            <div>‚Ä¢ block ${attackerInfo.ip}    - Block attacker IP address</div>
            <div>‚Ä¢ lock ${gameState.player}     - Lock compromised account</div>
            <div>‚Ä¢ enable-mfa            - Enable multi-factor authentication</div>
            <div>‚Ä¢ status                - Check system status</div>
            <div>‚Ä¢ help                  - Show this help message</div>
        </div>
    `;
}
 else if (cmd === `block ${attackerInfo.ip}`) {
                if (!terminalCommands.blocked) {
                    response = `<div style="color: var(--color-accent-green);">‚úì Firewall updated: IP ${attackerInfo.ip} blocked successfully</div>`;
                    terminalCommands.blocked = true;
                    gameState.evidence.push(`Blocked attacker IP: ${attackerInfo.ip}`);
                    gameState.mistakes++; // ‚úÖ ADD THIS
                    updateHUD(); // ‚úÖ ADD THIS
                    addScore(50);
                    success = true;
                } else {
                    response = '<div style="color: var(--color-warning);">‚ö†Ô∏è IP already blocked</div>';
                }
            } else if (cmd === `lock ${gameState.player}` || cmd.startsWith('lock ')){
    if (!terminalCommands.locked) {
        response = `<div style="color: var(--color-accent-green);">‚úì Account locked: ${gameState.player}</div>`; // ‚úÖ DYNAMIC
        terminalCommands.locked = true;
        gameState.evidence.push(`Locked compromised account: ${gameState.player}`); // ‚úÖ DYNAMIC
        addScore(50);
        success = true;
    } else {
        response = '<div style="color: var(--color-warning);">‚ö†Ô∏è Account already locked</div>';
    }
}
 else if (cmd === 'enable-mfa') {
                if (!terminalCommands.mfaEnabled) {
                    response = '<div style="color: var(--color-accent-green);">‚úì Multi-factor authentication enabled on all critical accounts</div>';
                    terminalCommands.mfaEnabled = true;
                    gameState.evidence.push('Enabled MFA on critical accounts');
                    addScore(50);
                    success = true;
                } else {
                    response = '<div style="color: var(--color-warning);">‚ö†Ô∏è MFA already enabled</div>';
                }
            } else if (cmd === 'status') {
                response = `
                    <div style="margin-top: 10px; color: var(--color-accent-cyan);">SYSTEM STATUS:</div>
                    <div style="margin-left: 20px;">
                        <div>IP Block: ${terminalCommands.blocked ? '<span style="color: var(--color-accent-green);">‚úì Active</span>' : '<span style="color: var(--color-danger);">‚úó Inactive</span>'}</div>
                        <div>Account Lock: ${terminalCommands.locked ? '<span style="color: var(--color-accent-green);">‚úì Active</span>' : '<span style="color: var(--color-danger);">‚úó Inactive</span>'}</div>
                        <div>MFA: ${terminalCommands.mfaEnabled ? '<span style="color: var(--color-accent-green);">‚úì Enabled</span>' : '<span style="color: var(--color-danger);">‚úó Disabled</span>'}</div>
                    </div>
                `;
            } else if (cmd.startsWith('block [') || cmd.startsWith('lock [')) {
                response = '<div style="color: var(--color-danger);">‚úó ERROR: Remove square brackets from command</div><div style="color: var(--color-text-secondary);">   Example: block 103.21.58.12 (not block [103.21.58.12])</div>';
            gameState.mistakes++; // ‚úÖ ADD THIS
            updateHUD(); // ‚úÖ ADD THIS
            
            } else {
                response = `<div style="color: var(--color-danger);">‚úó Command not found: ${cmd}</div><div style="color: var(--color-text-secondary);">   Type 'help' for available commands</div>`;
            }

            // Add response
            if (response) {
                const responseLine = document.createElement('div');
                responseLine.className = 'terminal-line';
                responseLine.innerHTML = response;
                output.appendChild(responseLine);
            }

            // Clear input
            input.value = '';
            output.scrollTop = output.scrollHeight;

            // Check completion
            if (success) {
                playSound('success');
                checkTerminalCompletion();
            }

            saveProgress();
        }

        function checkTerminalCompletion() {
            if (terminalCommands.blocked && terminalCommands.locked && terminalCommands.mfaEnabled) {
                document.getElementById('completeBtn').disabled = false;
                showNotification('‚úì All defensive measures deployed!', 'success');
                unlockAchievement('incident_response_complete');
            }
        }

        // ==================== LEVEL 5: FINAL DEFENSE (BOSS FIGHT) ====================
        
        let bossTasksComplete = {
            quickScan: 0,
            terminalDefense: 0,
            logReview: 0,
            networkSecure: 0
        };

        const bossTasksRequired = {
            quickScan: 6,
            terminalDefense: 4,
            logReview: 3,
            networkSecure: 1
        };

        function loadBossLevel(container) {
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 72px; margin-bottom: 10px;">‚öîÔ∏è</div>
                    <p style="color: var(--color-danger); font-family: var(--font-display); font-size: 18px;">COORDINATED MULTI-VECTOR ATTACK IN PROGRESS</p>
                    <p style="color: var(--color-text-secondary); margin-top: 10px;">Defend all systems simultaneously!</p>
                </div>

                <div class="boss-grid">
                    <div class="glass-panel boss-panel">
                        <h3 style="font-family: var(--font-display); font-size: 14px; color: var(--color-accent-cyan); margin-bottom: 15px;">‚ö° QUICK NETWORK SCAN</h3>
                        <p style="font-size: 11px; color: var(--color-text-secondary); margin-bottom: 10px;">Scan nodes: <span id="scanProgress">0/6</span></p>
                        <div class="quick-scan-grid" id="quickScanGrid"></div>
                    </div>

                    <div class="glass-panel boss-panel">
                        <h3 style="font-family: var(--font-display); font-size: 14px; color: var(--color-accent-cyan); margin-bottom: 15px;">üõ°Ô∏è TERMINAL COMMANDS</h3>
                        <p style="font-size: 11px; color: var(--color-warning); margin-bottom: 10px;">‚ö†Ô∏è EXECUTE IN EXACT ORDER: <span id="cmdProgress">0/4</span></p>
                        <div class="mini-terminal" id="bossTerminal" style="height: 150px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--color-accent-cyan); border-radius: 6px; font-family: var(--font-mono); font-size: 12px;">
                            <div style="color: var(--color-accent-green); margin-bottom: 8px;">REQUIRED SEQUENCE:</div>
                            <div style="color: var(--color-text-secondary); line-height: 1.8;">
                                1. scan network<br>
                                2. isolate 192.168.1.45<br>
                                3. block 103.21.58.12<br>
                                4. lockdown system
                            </div>
                            <div style="color: var(--color-danger); margin-top: 10px; font-size: 11px;">Wrong commands = -10% health & -10 points!</div>
                        </div>
                        <div class="terminal-input-area" style="margin-top: 10px; display: flex; align-items: center; background: rgba(0,0,0,0.5); border: 1px solid var(--color-accent-cyan); border-radius: 6px; padding: 8px;">
                            <div class="terminal-prompt" style="color: var(--color-accent-green); font-family: var(--font-mono); margin-right: 8px;">$</div>
                            <input type="text" class="terminal-input" id="bossTerminalInput" autocomplete="off" onkeydown="if(event.key==='Enter') handleBossTerminal()" style="flex: 1; background: transparent; border: none; outline: none; color: var(--color-text-primary); font-family: var(--font-mono);">
                        </div>
                    </div>

                    <div class="glass-panel boss-panel">
                        <h3 style="font-family: var(--font-display); font-size: 14px; color: var(--color-accent-cyan); margin-bottom: 15px;">üìä CRITICAL LOGS</h3>
                        <p style="font-size: 11px; color: var(--color-text-secondary); margin-bottom: 10px;">Identify threats: <span id="logProgress">0/3</span></p>
                        <div class="mini-terminal" id="bossLogs"></div>
                    </div>

                    <div class="glass-panel boss-panel">
                        <h3 style="font-family: var(--font-display); font-size: 14px; color: var(--color-accent-cyan); margin-bottom: 15px;">üîí FINAL LOCKDOWN</h3>
                        <p style="font-size: 11px; color: var(--color-text-secondary); margin-bottom: 15px;">Secure all systems: <span id="lockdownProgress">0/1</span></p>
                        <button class="btn" onclick="initiateLockdown()" id="lockdownBtn">INITIATE EMERGENCY LOCKDOWN</button>
                        <div id="lockdownStatus" style="margin-top: 15px; font-family: var(--font-mono); font-size: 11px;"></div>
                    </div>
                </div>
            `;

            initBossLevel();
            // Populate dynamic attacker info
    setTimeout(() => {
        const attackerInfo = getAttackerForAnalyst();
        const ipEl = document.getElementById('bossAttackerIP');
        const playerEl = document.getElementById('bossPlayerName');
        if (ipEl) ipEl.textContent = attackerInfo.ip;
        if (playerEl) playerEl.textContent = gameState.player || 'user';
    }, 100);

        }

        function initBossLevel() {
            // Quick scan nodes
            const scanGrid = document.getElementById('quickScanGrid');
            const nodes = [
                { icon: 'üî•', label: 'FW', threat: false },
                { icon: 'üîê', label: 'AUTH', threat: false },
                { icon: 'üíª', label: 'PC1', threat: true },
                { icon: 'üíª', label: 'PC2', threat: false },
                { icon: 'üíª', label: 'PC3', threat: true },
                { icon: '‚ö†Ô∏è', label: 'UNK', threat: true }
            ];

            nodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = 'quick-node';
                if (node.threat) nodeEl.classList.add('threat');
                nodeEl.innerHTML = `
                    <div class="node-icon">${node.icon}</div>
                    <div class="node-label">${node.label}</div>
                `;
                nodeEl.onclick = function() {
                    if (!this.classList.contains('scanned')) {
                        this.classList.add('scanned');
                        bossTasksComplete.quickScan++;
                        document.getElementById('scanProgress').textContent = `${bossTasksComplete.quickScan}/6`;
                        
                        if (node.threat) {
                            addScore(15);
                            playSound('threat');
                        } else {
                            addScore(5);
                            playSound('scan');
                        }
                        
                        checkBossCompletion();
                    }
                };
                scanGrid.appendChild(nodeEl);
            });

            // Boss logs
            const bossLogs = document.getElementById('bossLogs');
            const logs = [
                { text: '[INFO] System backup started', critical: false },
                { text: '[CRITICAL] Unauthorized access detected', critical: true },
                { text: '[INFO] User login successful', critical: false },
                { text: '[CRITICAL] Multiple failed login attempts', critical: true },
                { text: '[CRITICAL] Data exfiltration in progress', critical: true }
            ];

            logs.forEach(log => {
                const logEl = document.createElement('div');
                logEl.style.padding = '5px';
                logEl.style.margin = '3px 0';
                logEl.style.cursor = log.critical ? 'pointer' : 'default';
                logEl.style.color = log.critical ? 'var(--color-danger)' : 'var(--color-accent-green)';
                logEl.textContent = log.text;
                
                if (log.critical) {
                    logEl.onclick = function() {
                        if (this.style.background !== 'rgba(0, 255, 136, 0.2)') {
                            this.style.background = 'rgba(0, 255, 136, 0.2)';
                            bossTasksComplete.logReview++;
                            document.getElementById('logProgress').textContent = `${bossTasksComplete.logReview}/3`;
                            addScore(10);
                            playSound('success');
                            checkBossCompletion();
                        }
                    };
                }
                
                bossLogs.appendChild(logEl);
            });
        }

        function handleBossTerminal() {
            const input = document.getElementById('bossTerminalInput');
            const terminal = document.getElementById('bossTerminal');
            const cmd = input.value.trim().toLowerCase();

            const cmdLine = document.createElement('div');
            cmdLine.style.marginTop = '8px';
            cmdLine.style.color = 'var(--color-text-primary)';
            cmdLine.textContent = `$ ${input.value}`;
            terminal.appendChild(cmdLine);

            // Define EXACT correct commands in order
            const correctCommands = [
                'scan network',
                'isolate 192.168.1.45',
                'block 103.21.58.12',
                'lockdown system'
            ];
            
            // Track current expected command
            if (!window.bossCommandStep) window.bossCommandStep = 0;
            
            let success = false;
            let message = '';
            
            if (cmd === correctCommands[window.bossCommandStep]) {
                // CORRECT COMMAND
                success = true;
                window.bossCommandStep++;
                
                const responses = {
                    'scan network': '‚úì Network scan complete. Threats identified.',
                    'isolate 192.168.1.45': '‚úì User PC #1 isolated from network.',
                    'block 103.21.58.12': '‚úì Attacker IP blocked at firewall.',
                    'lockdown system': '‚úì System lockdown initiated.'
                };
                
                message = responses[cmd];
                
                const response = document.createElement('div');
                response.style.color = 'var(--color-accent-green)';
                response.style.marginTop = '3px';
                response.textContent = message;
                terminal.appendChild(response);
                
                addScore(50);
                bossTasksComplete.terminalDefense++;
                document.getElementById('cmdProgress').textContent = `${bossTasksComplete.terminalDefense}/4`;
                playSound('success');
                
                if (window.bossCommandStep >= correctCommands.length) {
                    const finalMsg = document.createElement('div');
                    finalMsg.style.color = 'var(--color-accent-cyan)';
                    finalMsg.style.marginTop = '10px';
                    finalMsg.style.fontWeight = 'bold';
                    finalMsg.textContent = 'üéØ All commands executed successfully!';
                    terminal.appendChild(finalMsg);
                }
                
            } else {
                // WRONG COMMAND - PENALTY
                const errorMsg = document.createElement('div');
                errorMsg.style.color = 'var(--color-danger)';
                errorMsg.style.marginTop = '3px';
                
                if (window.bossCommandStep === 0) {
                    errorMsg.textContent = `‚úó ERROR: Must start with "scan network"`;
                } else if (window.bossCommandStep === 1) {
                    errorMsg.textContent = `‚úó ERROR: Next command is "isolate 192.168.1.45"`;
                } else if (window.bossCommandStep === 2) {
                    errorMsg.textContent = `‚úó ERROR: Next command is "block 103.21.58.12"`;
                } else if (window.bossCommandStep === 3) {
                    errorMsg.textContent = `‚úó ERROR: Final command is "lockdown system"`;
                } else {
                    errorMsg.textContent = '‚úó ERROR: Invalid command';
                }
                
                terminal.appendChild(errorMsg);
                
                // PENALTIES
                reduceHealth('wrongCommand');
                gameState.score = Math.max(0, gameState.score - 10);
                updateHUD();
                showNotification('‚ö†Ô∏è Wrong command! -10 points, -10% health. Commands must be exact and in order.', 'error');
                playSound('alert');
            }

            input.value = '';
            terminal.scrollTop = terminal.scrollHeight;

            if (success) {
                checkBossCompletion();
            }
        }

        function initiateLockdown() {
            const btn = document.getElementById('lockdownBtn');
            const status = document.getElementById('lockdownStatus');
            
            btn.disabled = true;
            btn.textContent = 'LOCKDOWN IN PROGRESS...';

            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                status.innerHTML = `<div style="color: var(--color-accent-cyan);">Securing systems... ${progress}%</div>`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    status.innerHTML = '<div style="color: var(--color-accent-green);">‚úì EMERGENCY LOCKDOWN COMPLETE</div>';
                    btn.textContent = '‚úì LOCKDOWN ACTIVE';
                    btn.classList.add('completed');
                    bossTasksComplete.networkSecure = 1;
                    document.getElementById('lockdownProgress').textContent = '1/1';
                    addScore(50);
                    playSound('success');
                    checkBossCompletion();
                }
            }, 500);
        }

        function checkBossCompletion() {
            const allComplete = 
                bossTasksComplete.quickScan >= bossTasksRequired.quickScan &&
                bossTasksComplete.terminalDefense >= bossTasksRequired.terminalDefense &&
                bossTasksComplete.logReview >= bossTasksRequired.logReview &&
                bossTasksComplete.networkSecure >= bossTasksRequired.networkSecure;

            if (allComplete) {
                document.getElementById('completeBtn').disabled = false;
                showNotification('üéØ All systems secured! Final defense successful!', 'success');
                unlockAchievement('boss_defeated');
            }
        }

        // ==================== COMPLETE LEVEL ====================
        
        function completeLevel() {
            const currentLevel = gameState.currentLevel;
            
            if (!gameState.levelsCompleted.includes(currentLevel)) {
                gameState.levelsCompleted.push(currentLevel);
                addScore(levels[currentLevel - 1].completionScore);
                playSound('levelComplete');
                showNotification(`‚úì LEVEL ${currentLevel} COMPLETE!`, 'success');
            }

            // Check if all levels complete
            if (currentLevel >= 5) {
                finishMission();
            } else {
                // Move to next level
                setTimeout(() => {
                    gameState.currentLevel++;
                    loadLevel(gameState.currentLevel);
                    saveToLeaderboard(); // Update leaderboard with new level
                }, 2000);
            }

            saveProgress();
            saveToLeaderboard(); // Update leaderboard
        }

        // ==================== FINISH MISSION ====================
        
        function finishMission() {
            gameState.endTime = Date.now();
            
            // Hide game
            document.getElementById('gameHUD').classList.remove('active');
            document.getElementById('gameContainer').classList.remove('active');
            
            // Show results
            displayResults();
            
            playSound('missionComplete');
        }

        function displayResults() {
            const screen = document.getElementById('resultsScreen');
            screen.classList.add('active');

            const score = gameState.score;
            const health = gameState.health;
            const evidence = gameState.evidence.length;

            // Determine rank and ending
            let rank, title, subtitle, message, messageColor;

            if (score >= ENDING_THRESHOLDS.PERFECT) {
                rank = 'üèÜ';
                title = 'PERFECT EXECUTION';
                subtitle = 'Elite Security Analyst';
                message = 'Outstanding performance! You neutralized all threats with zero errors. The company security is intact, and you\'ve been promoted to Senior Security Analyst. Your skills are exceptional.';
                messageColor = 'var(--color-accent-green)';
            } else if (score >= ENDING_THRESHOLDS.EXCELLENT) {
                rank = '‚≠ê';
                title = 'EXCELLENT PERFORMANCE';
                subtitle = 'Promoted to Analyst II';
                message = 'Impressive work! You successfully contained the breach with minimal damage. Security protocols have been updated, and you\'ve earned a promotion. Keep up the great work!';
                messageColor = 'var(--color-accent-cyan)';
            } else if (score >= ENDING_THRESHOLDS.ADEQUATE) {
                rank = '‚úì';
                title = 'BREACH CONTAINED';
                subtitle = 'Acceptable Performance';
                message = 'The threat has been neutralized, though some data was compromised. Your performance was adequate, but there\'s room for improvement. Additional training recommended.';
                messageColor = 'var(--color-warning)';
            } else if (score >= ENDING_THRESHOLDS.POOR) {
                rank = '‚ö†Ô∏è';
                title = 'MAJOR DAMAGE';
                subtitle = 'Retraining Required';
                message = 'The attack caused significant damage to company systems. Critical data was stolen, and security protocols were breached. You need immediate retraining before returning to active duty.';
                messageColor = 'var(--color-danger)';
            } else {
                rank = 'üí•';
                title = 'CATASTROPHIC FAILURE';
                subtitle = 'Mission Failed';
                message = 'Complete security breach! The attacker successfully exfiltrated all critical data. Company systems are severely compromised. Your security clearance has been revoked pending investigation.';
                messageColor = 'var(--color-danger)';
            }

            document.getElementById('resultsRank').textContent = rank;
            document.getElementById('resultsTitle').textContent = title;
            document.getElementById('resultsSubtitle').textContent = subtitle;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalHealth').textContent = health + '%';
            document.getElementById('evidenceCollected').textContent = evidence;
            
            const messageEl = document.getElementById('performanceMessage');
            messageEl.style.borderLeftColor = messageColor;
            messageEl.querySelector('p').textContent = message;
            messageEl.querySelector('p').style.color = 'var(--color-text-primary)';

            // Save final results
            saveProgress();
        }

        // ==================== HUD UPDATES ====================
        
        function updateHUD() {
    // ‚úÖ UPDATE HEALTH WITH FROZEN INDICATOR
    const healthValue = document.getElementById('healthValue');
    if (gameState.healthFrozen) {
        healthValue.innerHTML = `${gameState.health}% <span style="color: var(--color-warning); font-size: 9px; margin-left: 4px;">üîí FROZEN</span>`;
    } else {
        healthValue.textContent = gameState.health + '%';
    }
    
    // ‚úÖ UPDATE SCORE WITH FROZEN INDICATOR
    const scoreValue = document.getElementById('scoreValue');
    if (gameState.scoreFrozen) {
        scoreValue.innerHTML = `${gameState.score} / 1250 <span style="color: var(--color-warning); font-size: 9px; margin-left: 4px;">üîí FROZEN</span>`;
    } else {
        scoreValue.textContent = gameState.score + ' / 1250';
    }
    
    document.getElementById('mistakeCount').textContent = gameState.mistakes;
    document.getElementById('lifelineCount').textContent = gameState.lifelines;
    
    const healthFill = document.getElementById('healthFill');
    healthFill.style.width = gameState.health + '%';
    
    if (gameState.health <= 30) {
        healthFill.classList.remove('warning');
        healthFill.classList.add('danger');
    } else if (gameState.health <= 60) {
        healthFill.classList.remove('danger');
        healthFill.classList.add('warning');
    } else {
        healthFill.classList.remove('warning', 'danger');
    }

    // Update lifeline icons
    for (let i = 1; i <= 3; i++) {
        const icon = document.getElementById(`life${i}`);
        if (icon) {
            if (i > gameState.lifelines) {
                icon.classList.add('used');
            } else {
                icon.classList.remove('used');
            }
        }
    }

    // Show/hide lifeline button (not in level 1)
    const lifelineBtn = document.getElementById('lifelineBtn');
    if (lifelineBtn) {
        if (gameState.currentLevel > 1 && gameState.lifelines > 0 && !gameState.isBanned) {
            lifelineBtn.style.display = 'inline-block';
        } else {
            lifelineBtn.style.display = 'none';
        }
    }
}


        function updateAttackMeter() {
            const pips = document.querySelectorAll('.attack-pip');
            pips.forEach((pip, index) => {
                if (index < gameState.attackIntensity) {
                    pip.classList.add('active');
                } else {
                    pip.classList.remove('active');
                }
            });
        }

     
function addScore(points) {
    // ‚úÖ CHECK IF SCORE IS FROZEN (after unblock)
    if (gameState.scoreFrozen) {
        showNotification('‚ö†Ô∏è Score FROZEN - Cannot gain points after unblock', 'warning');
        return; // Do not add score
    }
    
    gameState.score += points;
    
    // Cap score at 1250 maximum
    if (gameState.score > 1250) {
        gameState.score = 1250;
    }
    
    updateHUD();
    saveProgress();
}


     function reduceHealth(type = 'default') {
    // ‚úÖ CHECK IF HEALTH IS FROZEN (after unblock)
    if (gameState.healthFrozen) {
        // Health stays at 20%, but still count mistakes
        gameState.mistakes++;
        updateHUD();
        showNotification('‚ö†Ô∏è Health FROZEN at 20% - Cannot decrease further', 'warning');
        saveProgress();
        return; // Do not reduce health or re-block
    }
    
    const penalties = {
        'wrongNode': 10,
        'wrongLog': 5,
        'wrongCommand': 10,
        'default': 10
    };
    
    const amount = penalties[type] || penalties.default;
    gameState.health = Math.max(0, gameState.health - amount);
    gameState.mistakes++;
    updateHUD();
    
    // ‚úÖ CHECK IF HEALTH IS 20% OR BELOW - AUTO BLOCK
    if (gameState.health <= 20 && !gameState.isBanned) {
        // Calculate score penalty based on health and mistakes
        const healthPenalty = Math.floor((100 - gameState.health) * 2); // Up to 200 points
        const mistakePenalty = gameState.mistakes * 10; // 10 points per mistake
        gameState.score = Math.max(0, gameState.score - healthPenalty - mistakePenalty);
        
        // Block the analyst
        gameState.isBanned = true;
        gameState.banReason = `Security Health dropped to ${gameState.health}% (Critical Threshold: 20%)`;
        gameState.banTime = Date.now();
        
        updateHUD();
        saveProgress();
        saveToLeaderboard();
        
        // ‚úÖ SHOW ALERT MESSAGE FIRST (blocking alert popup)
        setTimeout(() => {
            alert(`üîí ACCOUNT LOCKED!\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚ö†Ô∏è CRITICAL SECURITY BREACH\n\nYour Security Health: ${gameState.health}%\nCritical Threshold: 20%\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüö® Account Status: LOCKED\nüìä Final Score: ${gameState.score}\n‚ùå Total Mistakes: ${gameState.mistakes}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚ö° Your account has been locked due to\ncritical security health levels.\n\nüë®‚Äçüè´ Please contact the instructor to\nunlock your account and resume.\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
        }, 100);
        
        showNotification('üîí ACCOUNT LOCKED! Health reached critical level.', 'error');
        playSound('alert');
        
        // Show ban screen after alert is dismissed
        setTimeout(() => {
            showBanScreen();
        }, 500);
        
        return; // Stop further execution
    }
    
    if (gameState.health <= 30) {
        showNotification(`‚ö†Ô∏è CRITICAL! Security Health at ${gameState.health}%`, 'error');
        playSound('alert');
    } else if (gameState.health <= 60) {
        showNotification(`‚ö†Ô∏è Health reduced to ${gameState.health}% (-${amount}%)`, 'warning');
    }
    
    saveProgress();
}




        // ==================== ACHIEVEMENTS ====================
        
        function unlockAchievement(id) {
            if (gameState.achievements.includes(id)) return;
            
            gameState.achievements.push(id);
            
            const achievements = {
                network_complete: { icon: 'üåê', title: 'Network Scanner' },
                forensics_complete: { icon: 'üîç', title: 'Log Detective' },
                diagram_complete: { icon: 'üìä', title: 'Attack Visualizer' },
                osint_complete: { icon: 'üéØ', title: 'Intelligence Analyst' },
                incident_response_complete: { icon: 'üõ°Ô∏è', title: 'Incident Responder' },
                boss_defeated: { icon: '‚öîÔ∏è', title: 'Threat Neutralizer' }
            };

            const achievement = achievements[id];
            if (achievement) {
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';
                popup.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-title">Achievement Unlocked!</div>
                    <div style="color: var(--color-text-secondary); margin-top: 5px;">${achievement.title}</div>
                `;
                document.body.appendChild(popup);

                playSound('achievement');

                setTimeout(() => {
                    popup.remove();
                }, 3000);
            }
            
            saveProgress();
        }

        // ==================== NOTIFICATIONS ====================
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            
            container.appendChild(notif);

            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 4000);
        }

        // ==================== SOUND SYSTEM ====================
        
        // Sound system - reuse AudioContext to prevent memory leaks
        let audioContext = null;

        function playSound(type) {
            // Simple beep using Web Audio API
            try {
                // Create context only once
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                const frequencies = {
                    scan: 800,
                    success: 1200,
                    threat: 400,
                    alert: 200,
                    levelStart: 600,
                    levelComplete: 1000,
                    start: 700,
                    achievement: 1500,
                    missionComplete: 1800
                };

                oscillator.frequency.value = frequencies[type] || 800;
                gainNode.gain.value = 0.1;
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                // Audio not supported
            }
        }

        // ==================== HELP SYSTEM ====================
        
        function showHelp() {
            const level = levels[gameState.currentLevel - 1];
            let helpText = '';

            switch (level.type) {
                case 'network':
                    helpText = 'Click on each network node to scan it. Look for suspicious connections and unusual traffic patterns. Threats will be marked in red.';
                    break;
                case 'logs':
                    helpText = 'Review the streaming log feed. Click on suspicious entries (warnings and critical alerts) to add them to your attack timeline. Build the complete attack sequence.';
                    break;
                case 'osint':
                    helpText = 'Use all available intelligence tools to research the attacker. Click each lookup button to gather comprehensive threat intelligence.';
                    break;
                case 'terminal':
                    helpText = 'Type security commands to neutralize threats. Use "help" to see available commands. Remember: no square brackets in commands!';
                    break;
                case 'boss':
                    helpText = 'Coordinate responses across all systems simultaneously. Complete quick scans, execute terminal commands, review critical logs, and initiate lockdown.';
                    break;
            }

            showNotification('üí° ' + helpText, 'info');
        }

        // ==================== LIFELINE SYSTEM ====================
        
        function useLifeline() {
            if (gameState.lifelines <= 0) {
                showNotification('‚ö†Ô∏è No lifelines remaining!', 'error');
                return;
            }

            if (gameState.currentLevel === 1) {
                showNotification('‚ö†Ô∏è Lifelines not available in Level 1', 'warning');
                return;
            }

            gameState.lifelines--;

            // Restore 10% health
            gameState.health = Math.min(100, gameState.health + 10);
            
            // Provide hint based on current level - DYNAMIC
const attackerInfo = getAttackerForAnalyst(); // ‚úÖ GET DYNAMIC DATA
const hints = {
    2: `Focus on [WARN] and [CRITICAL] log entries showing repeated login failures from ${attackerInfo.ip}`,
    3: `Label ALL components: Internet, Firewall, Auth Server, User PCs, and Attacker with their IPs`,
    4: `Search for attacker IP ${attackerInfo.ip} and compromised account ${gameState.player} in threat databases`,
    5: `Complete all 4 panels: scan all nodes, execute terminal commands, review critical logs, initiate lockdown`
};

            const hint = hints[gameState.currentLevel] || 'Review the instructions carefully and look for patterns';
            
            showNotification(`üí° HINT: ${hint}`, 'success');
            showNotification(`Lifeline used! ${gameState.lifelines} remaining`, 'warning');
            
            updateHUD();
            saveProgress();
            playSound('success');
        }

        // ==================== WRONG CLICK DETECTION & BAN ====================
        
        function recordWrongClick() {
            gameState.wrongClicks++;
             gameState.mistakes++;  // ADD THIS LINE
            reduceHealth(10);

            if (gameState.wrongClicks === 2) {
                // Show warning
                setTimeout(() => {
                    alert(`‚ö†Ô∏è WARNING: You are making errors!

Pay close attention to instructions.
One more mistake and your access will be restricted.`);
                }, 300);
                showNotification('‚ö†Ô∏è FINAL WARNING!', 'error');
                playSound('alert');
            } else if (gameState.wrongClicks >= 4) {
                // Ban user
                banUser();
            }
        }

        function showBanScreen() {
    // Hide game screens
    document.getElementById('gameHUD').classList.remove('active');
    document.getElementById('gameContainer').classList.remove('active');
    document.getElementById('briefingScreen').classList.remove('active');
    
    // Show home screen with ban message
    document.getElementById('homeScreen').classList.add('active');
    
    const container = document.getElementById('levelContent') || document.querySelector('.game-container');
    
    if (container) {
        container.innerHTML = `
            <div style="text-align: center; padding: 100px 20px;">
                <div style="font-size: 120px; margin-bottom: 30px; animation: pulse 2s infinite;">üîí</div>
                <h2 style="color: var(--color-danger); font-size: 48px; margin-bottom: 20px; font-family: var(--font-display); text-transform: uppercase;">
                    ‚ö†Ô∏è ACCOUNT LOCKED
                </h2>
                <p style="color: #9ca3af; font-size: 22px; line-height: 2; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto;">
                    ${gameState.banReason || 'Your session has been locked due to security health reaching critical levels.'}<br>
                    Contact the instructor to unlock your account.
                </p>
                
                <div style="margin-top: 50px; padding: 40px; background: rgba(255, 68, 68, 0.15); border: 3px solid var(--color-danger); border-radius: 20px; max-width: 600px; margin: 40px auto;">
                    <p style="font-family: var(--font-mono); color: var(--color-danger); font-size: 18px; line-height: 2.5;">
                        <strong>Team:</strong> ${gameState.team}<br>
                        <strong>Player:</strong> ${gameState.player}<br>
                        <strong>Security Health:</strong> ${gameState.health}% <span style="color: #ff4444;">‚ö†Ô∏è CRITICAL</span><br>
                        <strong>Current Score:</strong> ${gameState.score} / 1250<br>
                        <strong>Total Mistakes:</strong> ${gameState.mistakes}<br>
                        <strong>Wrong Clicks:</strong> ${gameState.wrongClicks}<br>
                        <strong>Current Level:</strong> ${gameState.currentLevel} / 5<br>
                        <strong>Locked At:</strong> ${new Date(gameState.banTime || Date.now()).toLocaleString()}
                    </p>
                </div>
                
                <p style="color: #6b7280; font-size: 14px; margin-top: 40px;">
                    üîì Instructor can unlock your account from the admin dashboard
                </p>
            </div>
        `;
    }
    
    // Disable all game controls
    const completeBtn = document.getElementById('completeBtn');
    if (completeBtn) completeBtn.disabled = true;
    
    const lifelineBtn = document.getElementById('lifelineBtn');
    if (lifelineBtn) lifelineBtn.style.display = 'none';
    
    showNotification('üîí Account locked! Contact instructor to unlock.', 'error');
    playSound('alert');
}

// ‚úÖ KEEP banUser() as alias for backward compatibility
function banUser() {
    showBanScreen();
}


        // ==================== PROGRESS MANAGEMENT ====================
        
        function saveProgress() {
        gameState.lastUpdate = Date.now();
        gameState.systemIP = SYSTEM_IP;  // Always save current system IP
        localStorage.setItem(`cyberquest_${gameState.team}_${gameState.player}`, JSON.stringify(gameState));
        saveToLeaderboard();  // Update leaderboard
    }


function loadProgress() {
    if (!gameState.team || !gameState.player) return null;
    const key = `cyberquest_${gameState.team}_${gameState.player}`;
    console.log('Loading progress with key:', key);
    const saved = localStorage.getItem(key);
    return saved ? JSON.parse(saved) : null;
}


        // ==================== ADMIN DASHBOARD ====================
        
        // ========================================
// ADMIN DASHBOARD
// ========================================
let adminPollingInterval;

function loadAdminDashboard() {
    updateStudentList();
    updateBlockedList(); // ‚úÖ ADD THIS
    updateCompletedList();
    updateApprovalList();
    startApprovalPolling();
    
    // Auto-refresh every 3 seconds
  /*  adminPollingInterval = setInterval(() => {
        updateStudentList();
        updateApprovalList();
    }, 3000);*/
} 

function getAllStudents() {
    const students = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        // Check if key starts with 'cyberquest_' (with underscore) and is not leaderboard
        if (key.startsWith('cyberquest_') && key !== 'cyberquest_leaderboard') {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                // Ensure it has the required properties
                if (data && data.team && data.player) {
                    students.push(data);
                }
            } catch (e) {
                console.error('Error parsing student data:', e);
            }
        }
    }
    console.log('Found students:', students.length);
    return students;
}

// Get attacker assignment for current analyst (circular assignment)
    function getAttackerForAnalyst() {
        const allAnalysts = getAllStudents();
        
        if (allAnalysts.length <= 1) {
            // If only one analyst or none, return default
            return {
                team: 'UNKNOWN',
                player: 'External Attacker',
                ip: '103.21.58.12',
                location: 'Lagos, Nigeria'
            };
        }
        
        // Find current analyst's index
        const currentKey = `${gameState.team}_${gameState.player}`;
        let currentIndex = -1;
        
        for (let i = 0; i < allAnalysts.length; i++) {
            const key = `${allAnalysts[i].team}_${allAnalysts[i].player}`;
            if (key === currentKey) {
                currentIndex = i;
                break;
            }
        }
        
        // Assign next analyst as attacker (circular)
        let attackerIndex;
        if (currentIndex === -1) {
            // Current analyst not found, assign first one
            attackerIndex = 0;
        } else if (currentIndex === allAnalysts.length - 1) {
            // Last analyst, assign first as attacker (circular)
            attackerIndex = 0;
        } else {
            // Assign next analyst
            attackerIndex = currentIndex + 1;
        }
        
        const attacker = allAnalysts[attackerIndex];
        
        return {
            team: attacker.team || 'UNKNOWN',
            player: attacker.player || 'Unknown',
            ip: attacker.systemIP || SYSTEM_IP,
            location: `${attacker.team}'s Network`
        };
    }




function updateStudentList() {
    const list = document.getElementById('studentList');
    const students = getAllStudents();
    
    // ‚úÖ FILTER: Show only ACTIVE (not blocked) analysts
    const activeStudents = students.filter(s => !s.isBanned && s.health > 20);
    
    if (activeStudents.length === 0) {
        list.innerHTML = `<p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No active sessions</p>`;
        return;
    }
    
    // Sort by timestamp (most recent first)
    activeStudents.sort((a, b) => (b.startTime || 0) - (a.startTime || 0));
    
    list.innerHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-family: var(--font-mono); font-size: 11px;">
                <thead>
                    <tr style="background: rgba(0, 212, 255, 0.1); border-bottom: 2px solid var(--color-accent-cyan);">
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">S.No</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Team</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Player</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Level</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Score</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Health</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Mistakes</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Status</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-cyan); font-weight: bold;">Start Time</th>
                        <th style="padding: 12px 8px; text-align: center; color: var(--color-accent-cyan); font-weight: bold;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${activeStudents.map((s, index) => `
                        <tr style="border-bottom: 1px solid rgba(0, 212, 255, 0.1);">
                            <td style="padding: 10px 8px; color: var(--color-text-secondary);">${index + 1}</td>
                            <td style="padding: 10px 8px; color: var(--color-accent-cyan); font-weight: bold;">${s.team}</td>
                            <td style="padding: 10px 8px; color: var(--color-text-primary);">${s.player}</td>
                            <td style="padding: 10px 8px;">
                                <span style="background: rgba(0, 255, 136, 0.2); color: var(--color-accent-green); padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                                    ${s.currentLevel || 1}/5
                                </span>
                            </td>
                            <td style="padding: 10px 8px; color: var(--color-accent-green); font-weight: bold;">${s.score || 0}</td>
                            <td style="padding: 10px 8px;">
                                <span style="color: ${s.health >= 70 ? 'var(--color-accent-green)' : s.health >= 40 ? 'var(--color-warning)' : 'var(--color-danger)'}; font-weight: bold;">
                                    ${s.health || 0}%
                                </span>
                            </td>
                            <td style="padding: 10px 8px; color: ${(s.mistakes || 0) > 5 ? 'var(--color-danger)' : 'var(--color-text-secondary)'};">
                                ${s.mistakes || 0}
                            </td>
                            <td style="padding: 10px 8px;">
                                <span style="color: var(--color-accent-green); font-weight: bold; font-size: 10px;">
                                    ‚úì ACTIVE
                                </span>
                            </td>
                            <td style="padding: 10px 8px; color: var(--color-text-secondary); font-size: 10px;">
                                ${s.startTime ? new Date(s.startTime).toLocaleString('en-IN', { 
                                    day: '2-digit', 
                                    month: 'short', 
                                    hour: '2-digit', 
                                    minute: '2-digit'
                                }) : 'N/A'}
                            </td>
                            <td style="padding: 10px 8px; text-align: center;">
                                <button onclick="exportAnalyst('${s.team}', '${s.player}')" 
                                        style="padding: 6px 12px; background: linear-gradient(135deg, #00d4ff, #0088ff); 
                                               color: white; border: none; border-radius: 6px; 
                                               cursor: pointer; font-size: 10px; font-weight: bold; white-space: nowrap;">
                                    üì• EXPORT
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}


function updateBlockedList() {
    const list = document.getElementById('blockedList');
    const students = getAllStudents();
    
    // ‚úÖ FILTER: Show only BLOCKED analysts
    const blockedStudents = students.filter(s => s.isBanned || s.health <= 20);
    
    if (blockedStudents.length === 0) {
        list.innerHTML = `<p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No blocked analysts</p>`;
        return;
    }
    
    // Sort by ban time (most recent first)
    blockedStudents.sort((a, b) => (b.banTime || 0) - (a.banTime || 0));
    
    list.innerHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-family: var(--font-mono); font-size: 11px;">
                <thead>
                    <tr style="background: rgba(255, 68, 68, 0.1); border-bottom: 2px solid var(--color-danger);">
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">S.No</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">Team</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">Player</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">Level</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">Score</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">Health</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-danger); font-weight: bold;">Reason</th>
                        <th style="padding: 12px 8px; text-align: center; color: var(--color-danger); font-weight: bold;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    ${blockedStudents.map((s, index) => `
                        <tr style="border-bottom: 1px solid rgba(255, 68, 68, 0.1); background: rgba(255, 68, 68, 0.05);">
                            <td style="padding: 10px 8px; color: var(--color-text-secondary);">${index + 1}</td>
                            <td style="padding: 10px 8px; color: var(--color-danger); font-weight: bold;">${s.team}</td>
                            <td style="padding: 10px 8px; color: var(--color-text-primary);">${s.player}</td>
                            <td style="padding: 10px 8px;">
                                <span style="background: rgba(255, 68, 68, 0.2); color: var(--color-danger); padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                                    ${s.currentLevel || 1}/5
                                </span>
                            </td>
                            <td style="padding: 10px 8px; color: var(--color-warning); font-weight: bold;">${s.score || 0}</td>
                            <td style="padding: 10px 8px;">
                                <span style="color: var(--color-danger); font-weight: bold;">
                                    ${s.health || 0}% ‚ö†Ô∏è
                                </span>
                            </td>
                            <td style="padding: 10px 8px; color: var(--color-text-secondary); font-size: 10px; max-width: 200px;">
                                ${s.banReason || 'Health critical'}<br>
                                <span style="color: #6b7280; font-size: 9px;">
                                    ${s.banTime ? new Date(s.banTime).toLocaleString('en-IN', { 
                                        day: '2-digit', 
                                        month: 'short', 
                                        hour: '2-digit', 
                                        minute: '2-digit'
                                    }) : 'N/A'}
                                </span>
                            </td>
                            <td style="padding: 10px 8px; text-align: center;">
                                <button onclick="unlockAccount('${s.team}', '${s.player}')" 
                                        style="padding: 8px 16px; background: linear-gradient(135deg, #00ff88, #00d4ff); 
                                               color: var(--dark); border: none; border-radius: 6px; 
                                               cursor: pointer; font-size: 11px; font-weight: bold; white-space: nowrap;">
                                    üîì UNBLOCK
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// ‚úÖ UPDATE COMPLETED ANALYSTS LIST
function updateCompletedList() {
    const list = document.getElementById('completedList');
    const students = getAllStudents();
    
    // ‚úÖ FILTER: Show only COMPLETED analysts (all 5 levels done)
    const completedStudents = students.filter(s => s.levelsCompleted && s.levelsCompleted.length === 5);
    
    if (completedStudents.length === 0) {
        list.innerHTML = `<p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px;">No completed analysts</p>`;
        return;
    }
    
    // Sort by end time (most recent first)
    completedStudents.sort((a, b) => (b.endTime || 0) - (a.endTime || 0));
    
    list.innerHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-family: var(--font-mono); font-size: 11px;">
                <thead>
                    <tr style="background: rgba(0, 255, 136, 0.1); border-bottom: 2px solid var(--color-accent-green);">
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">S.No</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Team</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Player</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Final Score</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Final Health</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Mistakes</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Grade</th>
                        <th style="padding: 12px 8px; text-align: left; color: var(--color-accent-green); font-weight: bold;">Completion Time</th>
                        <th style="padding: 12px 8px; text-align: center; color: var(--color-accent-green); font-weight: bold;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${completedStudents.map((s, index) => {
                        const grade = s.score >= 1000 ? 'PERFECT' : 
                                     s.score >= 800 ? 'EXCELLENT' : 
                                     s.score >= 600 ? 'ADEQUATE' : 
                                     s.score >= 400 ? 'POOR' : 'CATASTROPHIC';
                        const gradeColor = s.score >= 800 ? '#00ff88' : 
                                          s.score >= 600 ? '#ffaa00' : '#ff4444';
                        
                        return `
                        <tr style="border-bottom: 1px solid rgba(0, 255, 136, 0.1); background: rgba(0, 255, 136, 0.02);">
                            <td style="padding: 10px 8px; color: var(--color-text-secondary);">${index + 1}</td>
                            <td style="padding: 10px 8px; color: var(--color-accent-green); font-weight: bold;">${s.team}</td>
                            <td style="padding: 10px 8px; color: var(--color-text-primary);">${s.player}</td>
                            <td style="padding: 10px 8px; color: var(--color-accent-green); font-weight: bold; font-size: 12px;">${s.score}/1250</td>
                            <td style="padding: 10px 8px; color: var(--color-accent-green); font-weight: bold;">${s.health}%</td>
                            <td style="padding: 10px 8px; color: var(--color-text-secondary);">${s.mistakes || 0}</td>
                            <td style="padding: 10px 8px;">
                                <span style="color: ${gradeColor}; font-weight: bold; font-size: 10px;">
                                    ${grade}
                                </span>
                            </td>
                            <td style="padding: 10px 8px; color: var(--color-text-secondary); font-size: 10px;">
                                ${s.endTime ? new Date(s.endTime).toLocaleString('en-IN', { 
                                    day: '2-digit', 
                                    month: 'short', 
                                    year: 'numeric',
                                    hour: '2-digit', 
                                    minute: '2-digit'
                                }) : 'N/A'}
                            </td>
                            <td style="padding: 10px 8px; text-align: center;">
                                <button onclick="exportCompletedAnalyst('${s.team}', '${s.player}')" 
                                        style="padding: 6px 12px; background: linear-gradient(135deg, #00ff88, #00d4ff); 
                                               color: var(--dark); border: none; border-radius: 6px; 
                                               cursor: pointer; font-size: 10px; font-weight: bold; white-space: nowrap;">
                                    üì• EXPORT WITH CERTIFICATE
                                </button>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}


function unlockAccount(team, player) {
    const key = `cyberquest_${team}_${player}`;
    const dataStr = localStorage.getItem(key);
    
    if (!dataStr) {
        showNotification('‚ùå Account not found!', 'error');
        return;
    }
    
    const state = JSON.parse(dataStr);
    const currentHealth = state.health || 0;
    const currentScore = state.score || 0;
    const currentLevel = state.currentLevel || 1;
    
    if (!confirm(`üîì Unblock ${player} (${team})?\n\nüìä CURRENT STATUS:\n‚Ä¢ Health: ${currentHealth}% ‚Üí Will be FROZEN at 20%\n‚Ä¢ Score: ${currentScore} ‚Üí FROZEN (no new points)\n‚Ä¢ Level: ${currentLevel}/5 (resume from here)\n\n‚ö†Ô∏è After unblock:\n‚úì Can continue playing\n‚úó Health FROZEN at 20%\n‚úó Score FROZEN (no increase)\n\nProceed?`)) {
        return;
    }
    
    try {
        // ‚úÖ UNBLOCK - FREEZE health at 20%, FREEZE score
        state.isBanned = false;
        state.banReason = null;
        state.unlockTime = Date.now();
        state.unlockedBy = 'Instructor';
        
        // ‚úÖ FREEZE HEALTH AT 20% - CANNOT CHANGE
        state.health = 20;
        state.healthFrozen = true; // Mark as frozen
        
        // ‚úÖ FREEZE SCORE - CANNOT INCREASE
        state.scoreFrozen = true; // Mark score as frozen
        
        // ‚ö†Ô∏è KEEP THESE UNCHANGED:
        // state.score - FROZEN (no increase allowed)
        // state.currentLevel - Resume from same level
        // state.mistakes - Keep count
        // state.wrongClicks - Keep count
        // state.evidence - Keep collected evidence
        
        // Save back to localStorage
        localStorage.setItem(key, JSON.stringify(state));
        
        // Update leaderboard
        const leaderboard = JSON.parse(localStorage.getItem('cyberquest_leaderboard') || '[]');
        const lbIndex = leaderboard.findIndex(e => e.team === team && e.player === player);
        if (lbIndex >= 0) {
            leaderboard[lbIndex].health = 20; // Frozen at 20%
            leaderboard[lbIndex].score = state.score;
            localStorage.setItem('cyberquest_leaderboard', JSON.stringify(leaderboard));
        }
        
        showNotification(`‚úì Unblocked ${player} (${team})\n‚ö†Ô∏è Health FROZEN at 20% | Score FROZEN at ${state.score}`, 'success');
        
        // Refresh dashboard
        refreshDashboard();
        
    } catch (error) {
        console.error('Error unlocking account:', error);
        showNotification('‚ùå Error unlocking account!', 'error');
    }
}

// ‚úÖ HELPER FUNCTION
function getCurrentHealth(team, player) {
    const key = `cyberquest_${team}_${player}`;
    const data = localStorage.getItem(key);
    if (data) {
        try {
            const state = JSON.parse(data);
            return state.health || 0;
        } catch (e) {
            return 0;
        }
    }
    return 0;
}


// ‚úÖ HELPER FUNCTION - Get current health for confirmation
function getCurrentHealth(team, player) {
    const key = `cyberquest_${team}_${player}`;
    const data = localStorage.getItem(key);
    if (data) {
        try {
            const state = JSON.parse(data);
            return state.health || 0;
        } catch (e) {
            return 0;
        }
    }
    return 0;
}

// ‚úÖ UNLOCK ALL BLOCKED ACCOUNTS AT ONCE
// ‚úÖ UNLOCK ALL BLOCKED ACCOUNTS AT ONCE
function unlockAllAccounts() {
    const students = getAllStudents();
    const blockedStudents = students.filter(s => s.isBanned || s.health <= 20);
    
    if (blockedStudents.length === 0) {
        showNotification('‚ÑπÔ∏è No locked accounts found', 'info');
        return;
    }
    
    const totalHealth = blockedStudents.reduce((sum, s) => sum + (s.health || 0), 0);
    const avgHealth = Math.round(totalHealth / blockedStudents.length);
    
    if (!confirm(`üîì Unlock ${blockedStudents.length} locked accounts?\n\n‚ö†Ô∏è All blocked analysts will regain access with:\n‚Ä¢ Current health levels (Average: ${avgHealth}%)\n‚Ä¢ Current scores (no increase)\n‚Ä¢ Current progress preserved\n\nProceed?`)) {
        return;
    }
    
    let unlocked = 0;
    blockedStudents.forEach(s => {
        const key = `cyberquest_${s.team}_${s.player}`;
        const dataStr = localStorage.getItem(key);
        if (dataStr) {
            try {
                const data = JSON.parse(dataStr);
                data.isBanned = false;
                data.banReason = null;
                data.unlockTime = Date.now();
                data.unlockedBy = 'Instructor (Bulk Unlock)';
                localStorage.setItem(key, JSON.stringify(data));
                unlocked++;
            } catch (e) {
                console.error('Error unlocking:', s.team, s.player, e);
            }
        }
    });
    
    showNotification(`‚úì Successfully unlocked ${unlocked} accounts`, 'success');
    refreshDashboard();
}


function updateApprovalList() {
    const list = document.getElementById('approvalList');
    const students = getAllStudents();
    const pending = students.filter(s => s.pendingApproval && !s.pendingApproval.rejected);
    
    if (pending.length === 0) {
        list.innerHTML = `<p style="color: var(--color-text-secondary); text-align: center; padding: 40px 20px">No pending approvals</p>`;
        return;
    }
    
    list.innerHTML = pending.map((s, index) => `
        <div class="approval-item" style="padding: 20px; margin-bottom: 20px; background: rgba(255, 170, 0, 0.1); border-left: 4px solid var(--color-warning); border-radius: 8px;">
            <div style="margin-bottom: 15px;">
                <div class="student-name" style="font-family: var(--font-mono); font-size: 16px; font-weight: bold; color: var(--color-text-primary); margin-bottom: 8px;">
                    ${s.player} - ${s.team}
                </div>
                <div style="font-size: 13px; color: #9ca3af;">
                    Attempt #${s.pendingApproval.attempt || 1} | Submitted: ${new Date(s.pendingApproval.timestamp).toLocaleTimeString()}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div>
                    <h4 style="color: var(--color-accent-green); margin-bottom: 10px; font-size: 14px;">üìã REFERENCE DIAGRAM (CORRECT):</h4>
                    <img id="ref_img_${index}" 
                         src="${REFERENCE_DIAGRAM_URL}" 
                         style="width: 100%; border: 3px solid var(--color-accent-green); border-radius: 8px; cursor: pointer; background: white;">
                </div>
                <div>
                    <h4 style="color: var(--color-warning); margin-bottom: 10px; font-size: 14px;">üìù STUDENT SUBMISSION:</h4>
                    <img id="student_img_${index}" 
                         src="${s.pendingApproval.drawing}" 
                         style="width: 100%; border: 3px solid var(--color-accent-cyan); border-radius: 8px; cursor: pointer; background: white;">
                </div>
            </div>
            
            <div style="margin: 15px 0;">
                <label style="display: block; color: var(--color-text-secondary); font-size: 12px; margin-bottom: 8px;">ISSUE (for rejection):</label>
                <select id="feedback_${index}" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid var(--color-accent-cyan); border-radius: 6px; font-family: var(--font-mono); cursor: pointer;">
                    <option value="">No issues - Approve</option>
                    <option value="missing_internet">Missing Internet Gateway</option>
                    <option value="missing_firewall">Missing Firewall</option>
                    <option value="missing_auth">Missing Auth Server</option>
                    <option value="missing_pc1">Missing User PC #1 (Compromised)</option>
                    <option value="missing_pc2">Missing User PC #2</option>
                    <option value="missing_attacker">Missing Attacker Node</option>
                    <option value="missing_labels">Missing or Incorrect Labels</option>
                    <option value="wrong_arrows">Wrong Attack Path/Arrows</option>
                    <option value="no_attack_path">No Attack Path Shown</option>
                    <option value="incomplete">Incomplete Diagram</option>
                </select>
            </div>
            <div style="margin: 15px 0;">
                <label style="display: block; color: var(--color-text-secondary); font-size: 12px; margin-bottom: 8px;">ADDITIONAL FEEDBACK (optional):</label>
                <input type="text" id="custom_feedback_${index}" placeholder="Enter specific feedback for student..." style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid var(--color-accent-cyan); border-radius: 6px; font-family: var(--font-mono);">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="approve-btn" 
                        data-team="${s.team}" 
                        data-player="${s.player}"
                        data-index="${index}"
                        style="flex: 1; padding: 12px 20px; background: var(--color-accent-green); color: var(--color-bg-primary); border: none; border-radius: 6px; font-family: var(--font-display); font-size: 13px; font-weight: bold; cursor: pointer; text-transform: uppercase;">
                    ‚úì APPROVE
                </button>
                <button class="reject-btn" 
                        data-team="${s.team}" 
                        data-player="${s.player}"
                        data-index="${index}"
                        style="flex: 1; padding: 12px 20px; background: var(--color-danger); color: white; border: none; border-radius: 6px; font-family: var(--font-display); font-size: 13px; font-weight: bold; cursor: pointer; text-transform: uppercase;">
                    ‚úó REJECT & SEND FEEDBACK
                </button>
            </div>
        </div>
    `).join('');
    
    // ATTACH IMAGE CLICK HANDLERS AFTER HTML IS RENDERED
    setTimeout(() => {
        pending.forEach((s, index) => {
            const refImg = document.getElementById(`ref_img_${index}`);
            const studentImg = document.getElementById(`student_img_${index}`);
            
            if (refImg) {
                refImg.onclick = function() {
                    console.log('Reference diagram clicked');
                    viewDrawing(REFERENCE_DIAGRAM_URL);
                };
            }
            
            if (studentImg) {
                const drawingData = s.pendingApproval.drawing;
                studentImg.onclick = function() {
                    console.log('Student submission clicked');
                    console.log('Drawing data length:', drawingData ? drawingData.length : 0);
                    viewDrawing(drawingData);
                };
            }
        });
    }, 100);
    
    attachApprovalHandlers();
}

// New function to attach event handlers
function attachApprovalHandlers() {
    // Approve buttons
    document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const team = this.getAttribute('data-team');
            const player = this.getAttribute('data-player');
            approveDrawing(team, player);
        });
    });
    
    // Reject buttons
    document.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const team = this.getAttribute('data-team');
            const player = this.getAttribute('data-player');
            const index = this.getAttribute('data-index');
            console.log('Reject button clicked for:', team, player, 'Index:', index);
            rejectDrawing(team, player, index);
        });
    });

    
    // Drawing preview click
    document.querySelectorAll('.drawing-preview').forEach(img => {
        img.addEventListener('click', function() {
            viewDrawing(this.src);
        });
    });
}


function approveDrawing(team, player) {
    const key = `cyberquest_${team}_${player}`;
    console.log('Approving drawing for:', team, player);
    console.log('Looking for key:', key);
    
    const data = JSON.parse(localStorage.getItem(key));
    
    if (data) {
        console.log('Found student data:', data);
        
// ‚úÖ DOWNLOAD APPROVAL DATA FIRST
        downloadApprovalData(team, player, data, 'APPROVED');

        // Clear pending approval
        data.pendingApproval = null;
        
        // Mark level 3 as complete
        if (!data.levelsCompleted.includes(3)) {
            data.levelsCompleted.push(3);
            data.score += 100; // Award completion score
        }
        
        localStorage.setItem(key, JSON.stringify(data));
        console.log('Drawing approved successfully');
        showNotification(`Drawing approved for ${player} (${team})`, 'success');
        
        // Refresh lists
        updateApprovalList();
        updateStudentList();
    } else {
        console.error('Student data not found for key:', key);
        console.log('Available keys:', Object.keys(localStorage));
        showNotification('Error: Student data not found', 'error');
    }
}

function rejectDrawing(team, player, index) {
    console.log('=== rejectDrawing called ===');
    console.log('Team:', team, 'Player:', player, 'Index:', index);

    // Get feedback from dropdown and text input
    const feedbackSelect = document.getElementById(`feedback_${index}`);
    const customInput = document.getElementById(`custom_feedback_${index}`);

    const issue = feedbackSelect ? feedbackSelect.value : '';
    const customFeedback = customInput ? customInput.value : '';

    if (!issue && !customFeedback) {
        alert('Please select an issue or provide feedback before rejecting.');
        return;
    }

    const key = `cyberquest_${team}_${player}`;
    const dataStr = localStorage.getItem(key);

    if (!dataStr) {
        console.error('Student data not found for key:', key);
        showNotification('Error: Student data not found', 'error');
        return;
    }

    const data = JSON.parse(dataStr);

    if (!data.pendingApproval) {
        console.error('No pendingApproval found for student');
        showNotification('Error: No pending approval found for this student', 'error');
        return;
    }
// ‚úÖ DOWNLOAD REJECTION DATA FIRST
    downloadApprovalData(team, player, data, 'REJECTED', issue, customFeedback);
    // SCORE PENALTY: -50 points per rejection
    data.score = Math.max(0, data.score - 50);

// ‚úÖ INCREASE MISTAKES COUNT
data.mistakes = (data.mistakes || 0) + 1;

    // Mark as rejected with detailed feedback
    data.pendingApproval.rejected = true;
    data.pendingApproval.rejectionTime = Date.now();
    data.pendingApproval.feedback = {
        issue: issue,
        custom: customFeedback,
        issueText: issue ? feedbackSelect.options[feedbackSelect.selectedIndex].text : ''
    };

    // Track rejection count
    data.rejectionCount = (data.rejectionCount || 0) + 1;

    // Save back to localStorage
    localStorage.setItem(key, JSON.stringify(data));

    const feedbackMsg = issue 
        ? feedbackSelect.options[feedbackSelect.selectedIndex].text 
        : customFeedback;

    showNotification(
        `‚ùå Drawing rejected: ${player} (${team}) - ${feedbackMsg}. -50 points penalty.`,
        'error'
    );

    console.log('Rejection saved with feedback:', data.pendingApproval.feedback);

    updateApprovalList();
    updateStudentList();
}
// ‚úÖ DOWNLOAD APPROVAL/REJECTION DATA
function downloadApprovalData(team, player, data, status, issue = '', customFeedback = '') {
    const timestamp = new Date().toLocaleString('en-IN');
    
    // Create detailed report
    let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
    report += `‚ïë        CYBERQUEST - LEVEL 3 APPROVAL ${status.padEnd(16)}‚ïë\n`;
    report += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n`;
    
    report += `üìã ANALYST INFORMATION:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Team Name:           ${team}\n`;
    report += `Player Name:         ${player}\n`;
    report += `Approval Status:     ${status}\n`;
    report += `Timestamp:           ${timestamp}\n\n`;
    
    report += `üìä CURRENT PERFORMANCE:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Current Level:       ${data.currentLevel}/5\n`;
    report += `Current Score:       ${data.score}\n`;
    report += `Security Health:     ${data.health}%\n`;
    report += `Total Mistakes:      ${data.mistakes || 0}\n`;
    report += `Attempt Number:      ${data.pendingApproval ? data.pendingApproval.attempt : 'N/A'}\n`;
    report += `Total Rejections:    ${data.rejectionCount || 0}\n\n`;
    
    if (status === 'REJECTED') {
        report += `‚ùå REJECTION DETAILS:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        report += `Issue Type:          ${issue || 'Custom Feedback'}\n`;
        report += `Feedback:            ${customFeedback || 'See issue type'}\n`;
        report += `Score Penalty:       -50 points\n\n`;
    } else {
        report += `‚úÖ APPROVAL DETAILS:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        report += `Level 3 Status:      COMPLETED\n`;
        report += `Score Awarded:       +100 points\n\n`;
    }
    
    // Submission details
    if (data.pendingApproval) {
        report += `üìÖ SUBMISSION DETAILS:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        report += `Submission Time:     ${new Date(data.pendingApproval.timestamp).toLocaleString('en-IN')}\n`;
        report += `Drawing Image:       Included in submission\n\n`;
    }
    
    report += `${'‚ïê'.repeat(60)}\n`;
    report += `Report Generated:    ${timestamp}\n`;
    report += `Generated By:        Instructor Dashboard\n`;
    report += `${'‚ïê'.repeat(60)}\n`;
    
    // Download text report
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CyberQuest_Level3_${status}_${team}_${player}_${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    // ‚úÖ ALSO DOWNLOAD THE DRAWING IMAGE
    if (data.pendingApproval && data.pendingApproval.drawing) {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = data.pendingApproval.drawing;
            link.download = `CyberQuest_Level3_Drawing_${team}_${player}_${Date.now()}.png`;
            link.click();
        }, 500);
    }
    
    console.log(`‚úÖ Downloaded ${status} data for ${player} (${team})`);
}


function refreshDashboard() {
    // Save current form states before refresh
    const formStates = {};
    document.querySelectorAll('select[id^="feedback_"]').forEach(select => {
        formStates[select.id] = select.value;
    });
    document.querySelectorAll('input[id^="custom_feedback_"]').forEach(input => {
        formStates[input.id] = input.value;
    });
    
    updateStudentList();
     updateBlockedList(); // ‚úÖ ADD THIS
     updateCompletedList(); 
    updateApprovalList();
    
    // Restore form states after refresh
    setTimeout(() => {
        Object.keys(formStates).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = formStates[id];
            }
        });
    }, 100);
    
    showNotification('Dashboard refreshed', 'success');
}

                // Export Pending Approvals Data (Diagrams + Approval Status)
        function exportData() {
            const students = getAllStudents();
            
            // Filter students with pending or rejected approvals
            const approvalsData = students.filter(s => s.pendingApproval);
            
            if (approvalsData.length === 0) {
                showNotification('No approval data to export', 'warning');
                return;
            }
            
            // CSV Header
            let csv = 'S.No,Team Name,Player Name,Attempt Number,Submission Time,Approval Status,Rejection Reason,Rejection Count,Current Score,Current Health\n';
            
            // CSV Rows
            approvalsData.forEach((s, index) => {
                const approval = s.pendingApproval;
                const submissionTime = new Date(approval.timestamp).toLocaleString();
                const status = approval.rejected ? 'REJECTED' : 'PENDING';
                const rejectionReason = approval.feedback ? `${approval.feedback.issue} - ${approval.feedback.custom || 'N/A'}` : 'N/A';
                const rejectionCount = s.rejectionCount || 0;
                
                csv += `${index + 1},"${s.team}","${s.player}",${approval.attempt},"${submissionTime}","${status}","${rejectionReason}",${rejectionCount},${s.score},${s.health}\n`;
            });
            
            // Create download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CyberQuest_Approvals_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification(`‚úì Exported ${approvalsData.length} approval records`, 'success');
            
            // Also export diagrams as separate images
            exportDiagramImages(approvalsData);
        }
        
        // Export diagrams as separate image files (bonus feature)
        function exportDiagramImages(approvalsData) {
            approvalsData.forEach((s, index) => {
                const approval = s.pendingApproval;
                if (approval.drawing) {
                    // Create download link for each diagram
                    const a = document.createElement('a');
                    a.href = approval.drawing;
                    a.download = `Diagram_${s.team}_${s.player}_Attempt${approval.attempt}.png`;
                    a.click();
                }
            });
            
            showNotification(`‚úì Downloaded ${approvalsData.length} diagrams`, 'info');
        }


        // Export all analysts data to CSV (detailed)
       // ‚úÖ EXPORT SINGLE ANALYST DATA (Complete Report with Certificate Info)
function exportAnalyst(team, player) {
    const key = `cyberquest_${team}_${player}`;
    const dataStr = localStorage.getItem(key);
    
    if (!dataStr) {
        showNotification('‚ùå Analyst data not found', 'error');
        return;
    }
    
    const data = JSON.parse(dataStr);
    
    // Generate detailed report
    let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
    report += `‚ïë          CYBERQUEST - ANALYST PERFORMANCE REPORT           ‚ïë\n`;
    report += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n`;
    
    report += `üìã ANALYST INFORMATION:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Team Name:        ${data.team}\n`;
    report += `Player Name:      ${data.player}\n`;
    report += `Account Status:   ${data.isBanned ? 'üîí LOCKED' : '‚úì ACTIVE'}\n`;
    report += `Health Frozen:    ${data.healthFrozen ? 'YES (20%)' : 'NO'}\n`;
    report += `Score Frozen:     ${data.scoreFrozen ? 'YES' : 'NO'}\n\n`;
    
    report += `üìä PERFORMANCE METRICS:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Current Level:    ${data.currentLevel}/5\n`;
    report += `Final Score:      ${data.score}/1250 points\n`;
    report += `Security Health:  ${data.health}%\n`;
    report += `Total Mistakes:   ${data.mistakes || 0}\n`;
    report += `Wrong Clicks:     ${data.wrongClicks || 0}\n`;
    report += `Lifelines Used:   ${3 - (data.lifelines || 3)}/3\n`;
    report += `Evidence Count:   ${data.evidence ? data.evidence.length : 0}\n`;
    report += `Achievements:     ${data.achievements ? data.achievements.length : 0}/6\n\n`;
    
    report += `üéØ LEVEL COMPLETION STATUS:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    const levelNames = [
        'Network Reconnaissance',
        'Log Forensics',
        'Attack Visualization',
        'Threat Intelligence',
        'Final Defense'
    ];
    
    for (let i = 1; i <= 5; i++) {
        const completed = data.levelsCompleted && data.levelsCompleted.includes(i);
        report += `Level ${i} - ${levelNames[i-1]}: ${completed ? '‚úì COMPLETED' : '‚úó INCOMPLETE'}\n`;
    }
    report += `\n`;
    
    // Evidence
    if (data.evidence && data.evidence.length > 0) {
        report += `üîç EVIDENCE COLLECTED:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        data.evidence.forEach((e, i) => {
            report += `${i + 1}. ${e}\n`;
        });
        report += `\n`;
    }
    
    // Achievements
    if (data.achievements && data.achievements.length > 0) {
        report += `üèÜ ACHIEVEMENTS UNLOCKED:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        const achievementNames = {
            'networkcomplete': 'üåê Network Scanner',
            'forensicscomplete': 'üîç Log Detective',
            'diagramcomplete': 'üìä Attack Visualizer',
            'osintcomplete': 'üéØ Intelligence Analyst',
            'incidentresponsecomplete': 'üõ°Ô∏è Incident Responder',
            'bossdefeated': '‚öîÔ∏è Threat Neutralizer'
        };
        
        data.achievements.forEach((a, i) => {
            report += `${i + 1}. ${achievementNames[a] || a}\n`;
        });
        report += `\n`;
    }
    
    // Timeline
    report += `‚è±Ô∏è TIMELINE:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Start Time:       ${data.startTime ? new Date(data.startTime).toLocaleString('en-IN') : 'N/A'}\n`;
    report += `Last Update:      ${data.lastUpdate ? new Date(data.lastUpdate).toLocaleString('en-IN') : 'N/A'}\n`;
    if (data.endTime) {
        report += `Completion Time:  ${new Date(data.endTime).toLocaleString('en-IN')}\n`;
        const duration = Math.floor((data.endTime - data.startTime) / 60000);
        report += `Total Duration:   ${duration} minutes\n`;
    }
    if (data.banTime) {
        report += `Locked At:        ${new Date(data.banTime).toLocaleString('en-IN')}\n`;
        report += `Lock Reason:      ${data.banReason || 'Health critical'}\n`;
    }
    if (data.unlockTime) {
        report += `Unlocked At:      ${new Date(data.unlockTime).toLocaleString('en-IN')}\n`;
        report += `Unlocked By:      ${data.unlockedBy || 'Instructor'}\n`;
    }
    report += `\n`;
    
    // Certificate Status
    report += `üéì CERTIFICATE STATUS:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    if (data.currentLevel > 5 || (data.levelsCompleted && data.levelsCompleted.length === 5)) {
        report += `Status:           ‚úì CERTIFICATE ISSUED\n`;
        report += `Completion Date:  ${new Date(data.endTime || Date.now()).toLocaleString('en-IN')}\n`;
        report += `Final Grade:      ${data.score >= 1000 ? 'PERFECT' : data.score >= 800 ? 'EXCELLENT' : data.score >= 600 ? 'ADEQUATE' : data.score >= 400 ? 'POOR' : 'CATASTROPHIC'}\n`;
    } else {
        report += `Status:           ‚úó NOT YET COMPLETED\n`;
        report += `Progress:         ${data.currentLevel}/5 levels\n`;
    }
    report += `\n`;
    
    report += `${'‚ïê'.repeat(60)}\n`;
    report += `Report Generated: ${new Date().toLocaleString('en-IN')}\n`;
    report += `Generated By:     Instructor Dashboard\n`;
    report += `${'‚ïê'.repeat(60)}\n`;
    
    // Download as text file
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CyberQuest_${team}_${player}_Report_${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification(`‚úì Exported complete report for ${player} (${team})`, 'success');
}

// ‚úÖ EXPORT COMPLETED ANALYST WITH CERTIFICATE
function exportCompletedAnalyst(team, player) {
    const key = `cyberquest_${team}_${player}`;
    const dataStr = localStorage.getItem(key);
    
    if (!dataStr) {
        showNotification('‚ùå Analyst data not found', 'error');
        return;
    }
    
    const data = JSON.parse(dataStr);
    
    // Generate COMPLETE report with certificate
    let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
    report += `‚ïë     CYBERQUEST - COMPLETION CERTIFICATE & REPORT           ‚ïë\n`;
    report += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n`;
    
    report += `üéì CERTIFICATE OF COMPLETION\n`;
    report += `${'‚ïê'.repeat(60)}\n`;
    report += `This certifies that:\n\n`;
    report += `    ${player.toUpperCase()}\n`;
    report += `    Team: ${team.toUpperCase()}\n\n`;
    report += `Has successfully completed the CyberQuest Security Analyst\n`;
    report += `Training Program and demonstrated proficiency in:\n\n`;
    report += `  ‚úì Network Reconnaissance\n`;
    report += `  ‚úì Log Forensics & Analysis\n`;
    report += `  ‚úì Attack Visualization\n`;
    report += `  ‚úì Threat Intelligence\n`;
    report += `  ‚úì Incident Response & Defense\n\n`;
    report += `${'‚ïê'.repeat(60)}\n\n`;
    
    report += `üìä FINAL PERFORMANCE SUMMARY:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Final Score:         ${data.score}/1250\n`;
    report += `Final Health:        ${data.health}%\n`;
    report += `Total Mistakes:      ${data.mistakes || 0}\n`;
    report += `Wrong Clicks:        ${data.wrongClicks || 0}\n`;
    report += `Evidence Collected:  ${data.evidence ? data.evidence.length : 0}\n`;
    report += `Achievements:        ${data.achievements ? data.achievements.length : 0}/6\n\n`;
    
    const grade = data.score >= 1000 ? 'PERFECT ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê' : 
                  data.score >= 800 ? 'EXCELLENT ‚≠ê‚≠ê‚≠ê‚≠ê' : 
                  data.score >= 600 ? 'ADEQUATE ‚≠ê‚≠ê‚≠ê' : 
                  data.score >= 400 ? 'POOR ‚≠ê‚≠ê' : 'CATASTROPHIC ‚≠ê';
    
    report += `üèÜ FINAL GRADE:      ${grade}\n\n`;
    
    report += `üéØ LEVEL COMPLETION DETAILS:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    const levelNames = ['Network Reconnaissance', 'Log Forensics', 'Attack Visualization', 'Threat Intelligence', 'Final Defense'];
    for (let i = 1; i <= 5; i++) {
        report += `Level ${i} - ${levelNames[i-1]}: ‚úì COMPLETED\n`;
    }
    report += `\n`;
    
    // Evidence
    if (data.evidence && data.evidence.length > 0) {
        report += `üîç EVIDENCE COLLECTED:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        data.evidence.forEach((e, i) => {
            report += `${i + 1}. ${e}\n`;
        });
        report += `\n`;
    }
    
    // Achievements
    if (data.achievements && data.achievements.length > 0) {
        report += `üèÜ ACHIEVEMENTS UNLOCKED:\n`;
        report += `${'‚îÄ'.repeat(60)}\n`;
        const achievementNames = {
            'networkcomplete': 'üåê Network Scanner',
            'forensicscomplete': 'üîç Log Detective',
            'diagramcomplete': 'üìä Attack Visualizer',
            'osintcomplete': 'üéØ Intelligence Analyst',
            'incidentresponsecomplete': 'üõ°Ô∏è Incident Responder',
            'bossdefeated': '‚öîÔ∏è Threat Neutralizer'
        };
        data.achievements.forEach((a, i) => {
            report += `${i + 1}. ${achievementNames[a] || a}\n`;
        });
        report += `\n`;
    }
    
    // Timeline
    report += `‚è±Ô∏è COMPLETION TIMELINE:\n`;
    report += `${'‚îÄ'.repeat(60)}\n`;
    report += `Start Time:          ${data.startTime ? new Date(data.startTime).toLocaleString('en-IN') : 'N/A'}\n`;
    report += `Completion Time:     ${data.endTime ? new Date(data.endTime).toLocaleString('en-IN') : new Date().toLocaleString('en-IN')}\n`;
    if (data.startTime && data.endTime) {
        const duration = Math.floor((data.endTime - data.startTime) / 60000);
        report += `Total Duration:      ${duration} minutes\n`;
    }
    report += `\n`;
    
    report += `${'‚ïê'.repeat(60)}\n`;
    report += `Certificate Issued:  ${new Date().toLocaleString('en-IN')}\n`;
    report += `Authorized By:       Instructor Dashboard\n`;
    report += `${'‚ïê'.repeat(60)}\n`;
    
    // Download certificate
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CyberQuest_CERTIFICATE_${team}_${player}_${Date.now()}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification(`‚úÖ Downloaded certificate for ${player} (${team})`, 'success');
}



function viewDrawing(imageData) {
    const modal = document.getElementById('drawingModal');
    const img = document.getElementById('modalImage');
    
    // Set the image source
    img.src = imageData;
    
    // Apply white background and proper sizing
    img.style.maxWidth = '90%';
    img.style.maxHeight = '85vh';
    img.style.width = 'auto';
    img.style.height = 'auto';
    img.style.objectFit = 'contain';
    img.style.background = 'white';
    img.style.padding = '15px';
    img.style.borderRadius = '12px';
    img.style.border = '3px solid var(--color-accent-cyan)';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    
    // Show modal with proper centering and overflow
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.overflow = 'auto';
}


function logoutAdmin() {
    clearInterval(adminPollingInterval);
    document.getElementById('adminScreen').classList.remove('active');
    document.getElementById('homeScreen').classList.add('active');
    showNotification('Logged out', 'info');
}




        // ==================== MODAL ====================
        
        function closeModal() {
    const modal = document.getElementById('drawingModal');
    modal.style.display = 'none';
}


        // ==================== MISC FUNCTIONS ====================
        
        function viewReport() {
            const report = `
CYBERQUEST: OPERATION DIGITAL SHIELD
MISSION REPORT
=====================================

ANALYST: ${gameState.player}
TEAM: ${gameState.team}

FINAL STATS:
- Score: ${gameState.score}
- Security Health: ${gameState.health}%
- Evidence Collected: ${gameState.evidence.length}
- Levels Completed: ${gameState.levelsCompleted.length}/5
- Mistakes: ${gameState.mistakes}
- Achievements: ${gameState.achievements.length}

EVIDENCE TRAIL:
${gameState.evidence.map((e, i) => `${i + 1}. ${e}`).join('\n')}

ACHIEVEMENTS UNLOCKED:
${gameState.achievements.join(', ') || 'None'}

MISSION DURATION:
${gameState.endTime ? Math.floor((gameState.endTime - gameState.startTime) / 60000) : 0} minutes

=====================================
End of Report
            `;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cyberquest_report_${gameState.player}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('‚úì Report downloaded', 'success');
        }

        function playAgain() {
            if (confirm('Start a new operation? Current progress will be saved.')) {
                location.reload();
            }
        }

        // ==================== CERTIFICATE GENERATION ====================



       // Add this after the saveDrawing() function in Level 3

let approvalCheckInterval = null;

function startApprovalPolling() {
    // Check every 3 seconds for approval or rejection
    approvalCheckInterval = setInterval(() => {
        if (gameState.currentLevel !== 3) {
            clearInterval(approvalCheckInterval);
            return;
        }
        
        const savedData = loadProgress();
        
        if (savedData) {
            // Check if approved
            if (savedData.levelsCompleted.includes(3) && !gameState.levelsCompleted.includes(3)) {
                clearInterval(approvalCheckInterval);
                
                Object.assign(gameState, savedData);
                gameState.currentLevel = 4;
                saveProgress();
                
                showNotification('‚úÖ Drawing APPROVED! Proceeding to Level 4...', 'success');
                playSound('achievement');
                
                setTimeout(() => {
                    loadLevel(4);
                }, 2000);
            }
            
            // Check if rejected
            if (savedData.pendingApproval && savedData.pendingApproval.rejected) {
                const rejection = savedData.pendingApproval;
                
                // Only show notification once
                if (!gameState.lastRejectionTime || rejection.rejectionTime > gameState.lastRejectionTime) {
                    gameState.lastRejectionTime = rejection.rejectionTime;
                    gameState.score = savedData.score; // Update score with penalty
                    updateHUD();
                    
                    // Build feedback message
                    let feedbackMsg = '‚ùå DRAWING REJECTED\n\n';
                    if (rejection.feedback.issueText) {
                        feedbackMsg += `Issue: ${rejection.feedback.issueText}\n`;
                    }
                    if (rejection.feedback.custom) {
                        feedbackMsg += `Feedback: ${rejection.feedback.custom}\n`;
                    }
                    feedbackMsg += '\n-50 POINTS PENALTY\n\nPlease fix the issues and resubmit.';
                    
                    alert(feedbackMsg);
                    
                    // Clear pending approval to allow redraw
                    gameState.pendingApproval = null;
                    savedData.pendingApproval = null;
                    localStorage.setItem(`cyberquest_${gameState.team}_${gameState.player}`, JSON.stringify(savedData));
                    
                    // Re-enable submit button
                    const submitBtn = document.querySelector('button[onclick="saveDrawing()"]');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.textContent = 'üíæ RESUBMIT FOR APPROVAL';
                    }
                    
                    // Update status message
                    document.getElementById('drawingStatus').innerHTML = `
                        <div style="padding: 25px; background: rgba(255, 68, 68, 0.2); border: 2px solid var(--color-danger); border-radius: 12px; max-width: 700px; margin: 20px auto;">
                            <h3 style="color: var(--color-danger); font-size: 20px; margin-bottom: 15px;">‚ùå REJECTED - PLEASE REDRAW</h3>
                            <p style="color: #9ca3af; font-size: 16px; line-height: 1.8;">
                                ${rejection.feedback.issueText || 'Issues found'}<br>
                                ${rejection.feedback.custom ? rejection.feedback.custom + '<br>' : ''}
                                <br>
                                <strong style="color: var(--color-danger);">Penalty: -50 points</strong><br>
                                <strong>Current Score: ${gameState.score}</strong><br><br>
                                Fix the issues and resubmit your diagram.
                            </p>
                        </div>
                    `;
                }
            }
        }
    }, 3000); // Check every 3 seconds
}

// Stop polling when leaving the page
function stopApprovalPolling() {
    if (approvalCheckInterval) {
        clearInterval(approvalCheckInterval);
        approvalCheckInterval = null;
    }
}


        // ==================== INITIALIZE ON LOAD ====================
        
        window.onload = initGame;



// Enhanced modal closing - close on backdrop click
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('drawingModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    }
});




 function downloadCertificate() {
    console.log('üì• Downloading certificate...'); // Debug
    
    const rating = getPerformanceRating();
    
    // ‚úÖ Check if images are defined
    const certImage = typeof CERTIFICATE_IMAGE_BASE64 !== 'undefined' && CERTIFICATE_IMAGE_BASE64 
        ? CERTIFICATE_IMAGE_BASE64 
        : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI1MCIgZmlsbD0iI2ZmZDcwMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjIwIiBmaWxsPSIjMzMzIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5DRVJUSUZJQ0FURSBJTUFHRTWV4dD48L3N2Zz4=';
    
    const signImage = typeof SIGNATURE_IMAGE_BASE64 !== 'undefined' && SIGNATURE_IMAGE_BASE64 
        ? SIGNATURE_IMAGE_BASE64 
        : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjUwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE4IiBmb250LXN0eWxlPSJpdGFsaWMiIGZpbGw9IiMzMzMiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlNpZ25hdHVyZTwvdGV4dD48L3N2Zz4=';
    
    const certificateHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CyberQuest Certificate - ${gameState.player}</title>
    <style>
        @page { size: A4 landscape; margin: 0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .certificate {
            width: 900px;
            padding: 60px 80px;
            background: white;
            border: 20px solid #FFD700;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border-radius: 10px;
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 30px;
            margin-bottom: 40px;
        }
        h1 {
            font-size: 56px;
            color: #2c3e50;
            margin: 0 0 10px 0;
            letter-spacing: 2px;
        }
        .subtitle {
            font-size: 20px;
            color: #7f8c8d;
            margin: 0;
        }
        .awarded {
            font-size: 22px;
            color: #7f8c8d;
            margin: 30px 0 10px 0;
            text-align: center;
        }
        .recipient {
            font-size: 42px;
            color: #2c3e50;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
            display: inline-block;
            min-width: 400px;
        }
        .team {
            font-size: 24px;
            color: #7f8c8d;
            margin: 10px 0 40px 0;
            text-align: center;
        }
        .details-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
        }
        .cert-image {
            width: 200px;
            height: 250px;
            
            overflow: hidden;
            
            flex-shrink: 0;
        }
        .cert-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .details {
            line-height: 2.2;
            font-size: 18px;
            text-align: left;
            flex: 1;
        }
        .detail-row {
            margin: 15px 0;
        }
        .detail-label {
            font-weight: bold;
            color: #2c3e50;
        }
        .detail-value {
            color: #667eea;
            font-weight: bold;
        }
        .achievement {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            margin: 30px 0;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        .signature-section {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
        }
        .sig-box {
            text-align: center;
            width: 250px;
        }
        .sig-line {
            border-top: 2px solid #2c3e50;
            margin-bottom: 10px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sig-line img {
            max-width: 180px;
            max-height: 50px;
            display: block;
        }
        .sig-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #95a5a6;
        }
        .cert-id {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        .copyright {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
        }
        .copyright strong {
            color: #667eea;
        }
        @media print {
            body { padding: 0; background: white; }
            .certificate { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="certificate">
        <div class="header">
            <h1>üõ°Ô∏è CERTIFICATE OF ACHIEVEMENT</h1>
            <p class="subtitle">CyberQuest: Operation Digital Shield</p>
        </div>
        
        <p class="awarded">This certifies that</p>
        <div style="text-align: center;">
            <div class="recipient">${gameState.player}</div>
        </div>
        <p class="team">Team <strong>${gameState.team}</strong></p>
        
        <div style="text-align: center; margin: 40px 0;">
            <div style="margin: 20px 0;">
                Has successfully completed the cybersecurity training simulation<br>
                <strong>CYBERQUEST: Operation Digital Shield</strong>
            </div>
        </div>

        <div class="achievement">
            Performance Rating: ${rating}
        </div>

        <div class="details-container">
            <div class="cert-image">
                <img src="${certImage}" alt="Certificate Badge" onerror="this.style.display='none'">
            </div>
            
            <div class="details">
                <div class="detail-row">
                    <span class="detail-label">Final Score:</span> 
                    <span class="detail-value">${gameState.score} points</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Security Health:</span> 
                    <span class="detail-value">${gameState.health}%</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Levels Completed:</span> 
                    <span class="detail-value">${gameState.levelsCompleted.length}/5</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Evidence Collected:</span> 
                    <span class="detail-value">${gameState.evidence.length} items</span>
                </div>
            </div>
        </div>

        <div class="signature-section">
            <div class="sig-box">
                <div class="sig-line">
                    <img src="${signImage}" alt="Instructor Signature" onerror="this.parentElement.style.borderTop='2px solid #2c3e50'">
                </div>
                <div class="sig-label">Instructor Signature</div>
            </div>
            <div class="sig-box">
                <div class="sig-line"></div>
                <div class="sig-label">Date: ${new Date().toLocaleDateString('en-IN')}</div>
            </div>
        </div>

        <div class="footer">
            <div class="cert-id">
                Certificate ID: CQ-${Date.now()}-${gameState.team.replace(/\s/g, '')}-${gameState.player.replace(/\s/g, '')}
            </div>
            <p style="margin-top: 20px;">
                This certificate demonstrates proficiency in network security analysis,<br>
                threat detection, incident response, and cybersecurity best practices.
            </p>
            
            <div class="copyright">
                ¬© 2026 CyberQuest | Powered by <strong>Codespace Solutions</strong>, Coimbatore - 641062
            </div>
        </div>
    </div>
</body>
</html>
    `;
    
    try {
        const blob = new Blob([certificateHTML], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CyberQuest_Certificate_${gameState.player}_${Date.now()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        setTimeout(() => {
            URL.revokeObjectURL(url);
        }, 100);
        
        console.log('‚úÖ Certificate downloaded successfully!'); // Debug
        showNotification('‚úì Certificate downloaded! Open the HTML file to view or print.', 'success');
        playSound('achievement');
        
    } catch (error) {
        console.error('‚ùå Download error:', error);
        showNotification('‚ùå Error downloading certificate. Check console.', 'error');
    }

function getPerformanceRating() {
    if (gameState.score >= 800 && gameState.health >= 80) return '‚≠ê‚≠ê‚≠ê EXCELLENT - Cybersecurity Hero';
    if (gameState.score >= 600 && gameState.health >= 60) return '‚≠ê‚≠ê GOOD - Strong Performance';
    if (gameState.score >= 400) return '‚≠ê ADEQUATE - Satisfactory';
    return '‚ñ≥ NEEDS IMPROVEMENT';
}

}


    </script>
</body>
</html>
